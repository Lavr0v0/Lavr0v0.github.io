<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Step 4 æ–°äº¤äº’æµç¨‹æµ‹è¯•</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body class="bg-slate-100 p-8">
  <div class="max-w-4xl mx-auto">
    <h1 class="text-3xl font-bold text-slate-800 mb-6">Step 4 æ–°äº¤äº’æµç¨‹æµ‹è¯•</h1>
    
    <div class="bg-white p-6 rounded-xl shadow-lg mb-6">
      <h2 class="text-xl font-bold text-purple-900 mb-4">æ–°çš„ 5 æ­¥äº¤äº’æµç¨‹</h2>
      <ol class="list-decimal list-inside space-y-2 text-sm text-slate-700">
        <li><strong>æ­¥éª¤ 1</strong>: AI é—®é—®é¢˜ â†’ ç”¨æˆ·ç®€è¦å›ç­”</li>
        <li><strong>æ­¥éª¤ 2</strong>: AI æ ¹æ®ç”¨æˆ·å›ç­”ç”Ÿæˆè¯¦ç»†å†…å®¹</li>
        <li><strong>æ­¥éª¤ 3</strong>: ç”¨æˆ·æŸ¥çœ‹ AI ç”Ÿæˆçš„å†…å®¹ï¼Œé€‰æ‹©"æ»¡æ„"æˆ–"ä¸æ»¡æ„"</li>
        <li><strong>æ­¥éª¤ 4</strong>: å¦‚æœä¸æ»¡æ„ï¼Œé€‰æ‹©ä¿®æ”¹æ–¹å¼ï¼š
          <ul class="list-disc list-inside ml-6 mt-1">
            <li>ğŸ“ å°æ”¹ï¼šç›´æ¥ä¿®æ”¹æ–‡æœ¬</li>
            <li>ğŸ’¬ å¤§æ”¹ï¼šç»™ AI æå»ºè®®ï¼Œè®© AI é‡æ–°ç”Ÿæˆ</li>
          </ul>
        </li>
        <li><strong>æ­¥éª¤ 5</strong>: é€šè¿‡åè¿›å…¥ä¸‹ä¸€ä¸ªé—®é¢˜</li>
      </ol>
    </div>

    <div class="bg-white p-6 rounded-xl shadow-lg mb-6">
      <h2 class="text-xl font-bold text-purple-900 mb-4">API é…ç½®</h2>
      <div class="space-y-3">
        <div>
          <label class="text-sm font-bold text-slate-600">API URL</label>
          <input type="text" id="api-url" value="https://api.deepseek.com" class="w-full p-2 border rounded text-sm">
        </div>
        <div>
          <label class="text-sm font-bold text-slate-600">API Key</label>
          <input type="text" id="api-key" value="sk-a6158402691b45cf82f26fa841f2cd27" class="w-full p-2 border rounded text-sm">
        </div>
        <button onclick="startTest()" class="bg-purple-600 hover:bg-purple-700 text-white px-6 py-3 rounded-lg font-bold w-full">
          <i class="fa-solid fa-play"></i> å¼€å§‹æµ‹è¯•æ–°æµç¨‹
        </button>
      </div>
    </div>

    <div id="test-container" class="bg-white p-6 rounded-xl shadow-lg">
      <p class="text-center text-slate-400">ç‚¹å‡»"å¼€å§‹æµ‹è¯•æ–°æµç¨‹"å¼€å§‹</p>
    </div>

    <div id="answers-log" class="mt-6 bg-slate-800 text-green-400 p-4 rounded-xl font-mono text-xs">
      <div class="font-bold mb-2">ç­”æ¡ˆè®°å½•ï¼ˆè°ƒè¯•ç”¨ï¼‰ï¼š</div>
      <div id="log-content">ç­‰å¾…å¼€å§‹...</div>
    </div>
  </div>

  <script>
    const questionAnswers = {};
    let currentQuestions = [];
    let currentQuestionIndex = 0;

    const mockQuestions = [
      {
        id: 'scars',
        category: 'ç–¤ç—•æ¥æº',
        question: 'ä½ é€‰æ‹©äº†ä»¥ä¸‹ç–¤ç—•ï¼šè„¸éƒ¨åˆ€ç–¤ã€‚è¯·æè¿°è¿™ä¸ªç–¤ç—•æ˜¯å¦‚ä½•å½¢æˆçš„ï¼Ÿ',
        context: 'è§’è‰²æœ‰ç–¤ç—•: è„¸éƒ¨åˆ€ç–¤'
      }
    ];

    function startTest() {
      currentQuestions = [...mockQuestions];
      currentQuestionIndex = 0;
      Object.keys(questionAnswers).forEach(key => delete questionAnswers[key]);
      updateLog();
      showQuestion(0);
    }

    async function showQuestion(index) {
      if(index >= currentQuestions.length) {
        showCompletionSummary();
        return;
      }
      
      currentQuestionIndex = index;
      const q = currentQuestions[index];
      const container = document.getElementById('test-container');
      
      container.innerHTML = `
        <div class="bg-white p-6 rounded-xl shadow-sm border-2 border-purple-300">
          <div class="flex justify-between items-start mb-4">
            <div>
              <h4 class="text-lg font-bold text-purple-900 mb-1">æ­¥éª¤ 1/5: ${q.category}</h4>
              <p class="text-xs text-slate-500">é—®é¢˜ ${index + 1} / ${currentQuestions.length}</p>
            </div>
          </div>
          
          <div class="bg-purple-50 p-4 rounded-lg mb-4">
            <div class="flex items-start gap-2">
              <i class="fa-solid fa-robot text-purple-600 text-xl mt-1"></i>
              <div>
                <p class="text-xs font-bold text-purple-700 mb-1">AI çš„é—®é¢˜ï¼š</p>
                <p class="text-sm text-slate-700 leading-relaxed">${q.question}</p>
              </div>
            </div>
          </div>
          
          <div class="mb-4">
            <label class="text-xs font-bold text-slate-600 uppercase block mb-2">
              <i class="fa-solid fa-user"></i> ä½ çš„å›ç­”
            </label>
            <textarea id="user-initial-answer" class="w-full p-3 border-2 border-purple-300 rounded-lg text-sm resize-none focus:border-purple-500 focus:ring-2 focus:ring-purple-200" rows="4" placeholder="è¯·ç®€è¦å›ç­”è¿™ä¸ªé—®é¢˜ï¼ŒAI ä¼šæ ¹æ®ä½ çš„å›ç­”ç”Ÿæˆè¯¦ç»†å†…å®¹..."></textarea>
            <p class="text-xs text-slate-500 mt-1">ğŸ’¡ æç¤ºï¼šç®€å•æè¿°å³å¯ï¼ŒAI ä¼šå¸®ä½ æ‰©å±•æˆå®Œæ•´å†…å®¹</p>
          </div>
          
          <div class="flex justify-end pt-4 border-t">
            <button onclick="submitUserAnswer()" class="bg-purple-600 hover:bg-purple-700 text-white px-6 py-2 rounded-lg text-sm font-medium transition flex items-center gap-2">
              <i class="fa-solid fa-paper-plane"></i> æäº¤å›ç­”ï¼Œè®© AI ç”Ÿæˆè¯¦ç»†å†…å®¹
            </button>
          </div>
        </div>
      `;
    }

    async function submitUserAnswer() {
      const userAnswer = document.getElementById('user-initial-answer').value.trim();
      if(!userAnswer) {
        alert('è¯·å…ˆå›ç­”é—®é¢˜');
        return;
      }
      
      const q = currentQuestions[currentQuestionIndex];
      const container = document.getElementById('test-container');
      
      container.innerHTML = `
        <div class="bg-white p-6 rounded-xl shadow-sm border-2 border-purple-300">
          <div class="bg-slate-50 p-6 rounded-lg border border-slate-200 text-center">
            <i class="fa-solid fa-spinner fa-spin text-3xl text-purple-600 mb-3"></i>
            <p class="text-sm text-slate-600">AI æ­£åœ¨æ ¹æ®ä½ çš„å›ç­”ç”Ÿæˆè¯¦ç»†å†…å®¹...</p>
          </div>
        </div>
      `;
      
      try {
        const prompt = `${q.context}\n\né—®é¢˜ï¼š${q.question}\n\nç”¨æˆ·çš„å›ç­”ï¼š${userAnswer}\n\nè¯·æ ¹æ®ç”¨æˆ·çš„å›ç­”ï¼Œç”¨ç¬¬ä¸‰äººç§°ï¼Œç”Ÿæˆä¸€æ®µ150-200å­—çš„è¯¦ç»†æè¿°ã€‚`;
        const aiGenerated = await callAIText(prompt);
        showAIGeneratedContent(userAnswer, aiGenerated);
      } catch(e) {
        alert('AI ç”Ÿæˆå¤±è´¥ï¼š' + e.message);
        showQuestion(currentQuestionIndex);
      }
    }

    function showAIGeneratedContent(userAnswer, aiGenerated) {
      const container = document.getElementById('test-container');
      
      container.innerHTML = `
        <div class="bg-white p-6 rounded-xl shadow-sm border-2 border-purple-300">
          <div class="mb-4">
            <h4 class="text-lg font-bold text-purple-900 mb-1">æ­¥éª¤ 3/5: æŸ¥çœ‹ AI ç”Ÿæˆçš„å†…å®¹</h4>
          </div>
          
          <div class="bg-blue-50 p-4 rounded-lg mb-3">
            <div class="flex items-start gap-2">
              <i class="fa-solid fa-user text-blue-600 text-lg mt-1"></i>
              <div class="flex-1">
                <p class="text-xs font-bold text-blue-700 mb-1">ä½ çš„å›ç­”ï¼š</p>
                <p class="text-sm text-slate-700 leading-relaxed">${userAnswer}</p>
              </div>
            </div>
          </div>
          
          <div class="bg-green-50 p-4 rounded-lg mb-4 border-2 border-green-200">
            <div class="flex items-start gap-2">
              <i class="fa-solid fa-robot text-green-600 text-lg mt-1"></i>
              <div class="flex-1">
                <p class="text-xs font-bold text-green-700 mb-1">AI ç”Ÿæˆçš„è¯¦ç»†å†…å®¹ï¼š</p>
                <p class="text-sm text-slate-700 leading-relaxed whitespace-pre-wrap">${aiGenerated}</p>
              </div>
            </div>
          </div>
          
          <div class="bg-amber-50 p-4 rounded-lg mb-4 border border-amber-200">
            <p class="text-sm text-amber-800 font-medium mb-2">
              <i class="fa-solid fa-question-circle"></i> ä½ å¯¹è¿™ä¸ªå†…å®¹æ»¡æ„å—ï¼Ÿ
            </p>
            <div class="flex gap-3">
              <button onclick="approveContent()" class="flex-1 bg-green-600 hover:bg-green-700 text-white px-4 py-3 rounded-lg text-sm font-medium transition flex items-center justify-center gap-2">
                <i class="fa-solid fa-check-circle text-lg"></i>
                <span>æ»¡æ„ï¼Œé€šè¿‡</span>
              </button>
              <button onclick="showModifyOptions()" class="flex-1 bg-orange-600 hover:bg-orange-700 text-white px-4 py-3 rounded-lg text-sm font-medium transition flex items-center justify-center gap-2">
                <i class="fa-solid fa-edit text-lg"></i>
                <span>ä¸æ»¡æ„ï¼Œéœ€è¦ä¿®æ”¹</span>
              </button>
            </div>
          </div>
        </div>
      `;
      
      window.currentUserAnswer = userAnswer;
      window.currentAIGenerated = aiGenerated;
    }

    function showModifyOptions() {
      const container = document.getElementById('test-container');
      
      container.innerHTML = `
        <div class="bg-white p-6 rounded-xl shadow-sm border-2 border-orange-300">
          <div class="mb-4">
            <h4 class="text-lg font-bold text-orange-900 mb-1">æ­¥éª¤ 4/5: é€‰æ‹©ä¿®æ”¹æ–¹å¼</h4>
          </div>
          
          <div class="bg-slate-50 p-4 rounded-lg mb-4">
            <p class="text-xs font-bold text-slate-600 mb-2">å½“å‰ AI ç”Ÿæˆçš„å†…å®¹ï¼š</p>
            <p class="text-sm text-slate-700 leading-relaxed">${window.currentAIGenerated}</p>
          </div>
          
          <div class="space-y-3">
            <button onclick="chooseSmallEdit()" class="w-full bg-blue-600 hover:bg-blue-700 text-white p-4 rounded-lg text-left transition">
              <div class="flex items-start gap-3">
                <i class="fa-solid fa-pen text-2xl mt-1"></i>
                <div>
                  <p class="font-bold mb-1">ğŸ“ å°æ”¹ï¼šç›´æ¥ä¿®æ”¹æ–‡æœ¬</p>
                  <p class="text-sm opacity-90">é€‚åˆï¼šæ”¹å‡ ä¸ªå­—ã€è°ƒæ•´è¯­å¥ã€ä¿®æ­£ç»†èŠ‚</p>
                </div>
              </div>
            </button>
            
            <button onclick="chooseBigEdit()" class="w-full bg-purple-600 hover:bg-purple-700 text-white p-4 rounded-lg text-left transition">
              <div class="flex items-start gap-3">
                <i class="fa-solid fa-comments text-2xl mt-1"></i>
                <div>
                  <p class="font-bold mb-1">ğŸ’¬ å¤§æ”¹ï¼šç»™ AI æå»ºè®®</p>
                  <p class="text-sm opacity-90">é€‚åˆï¼šæ”¹å˜æ–¹å‘ã€å¢åŠ å†…å®¹ã€é‡æ–°æ„æ€</p>
                </div>
              </div>
            </button>
          </div>
        </div>
      `;
    }

    function chooseSmallEdit() {
      const container = document.getElementById('test-container');
      
      container.innerHTML = `
        <div class="bg-white p-6 rounded-xl shadow-sm border-2 border-blue-300">
          <div class="mb-4">
            <h4 class="text-lg font-bold text-blue-900 mb-1">æ­¥éª¤ 5/5: ç›´æ¥ä¿®æ”¹æ–‡æœ¬</h4>
          </div>
          
          <div class="mb-4">
            <label class="text-xs font-bold text-slate-600 uppercase block mb-2">
              <i class="fa-solid fa-edit"></i> ç¼–è¾‘å†…å®¹
            </label>
            <textarea id="manual-edit-content" class="w-full p-3 border-2 border-blue-300 rounded-lg text-sm resize-none" rows="8">${window.currentAIGenerated}</textarea>
          </div>
          
          <div class="flex justify-between pt-4 border-t">
            <button onclick="showModifyOptions()" class="text-slate-400 hover:text-slate-600 px-4 py-2 text-sm">
              <i class="fa-solid fa-arrow-left"></i> è¿”å›
            </button>
            <button onclick="saveManualEdit()" class="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded-lg text-sm font-medium">
              <i class="fa-solid fa-check"></i> ä¿å­˜å¹¶å®Œæˆ
            </button>
          </div>
        </div>
      `;
    }

    function chooseBigEdit() {
      const container = document.getElementById('test-container');
      
      container.innerHTML = `
        <div class="bg-white p-6 rounded-xl shadow-sm border-2 border-purple-300">
          <div class="mb-4">
            <h4 class="text-lg font-bold text-purple-900 mb-1">æ­¥éª¤ 5/5: ç»™ AI æå»ºè®®</h4>
          </div>
          
          <div class="bg-slate-50 p-4 rounded-lg mb-4">
            <p class="text-xs font-bold text-slate-600 mb-2">å½“å‰å†…å®¹ï¼š</p>
            <p class="text-sm text-slate-700 leading-relaxed">${window.currentAIGenerated}</p>
          </div>
          
          <div class="mb-4">
            <label class="text-xs font-bold text-slate-600 uppercase block mb-2">
              <i class="fa-solid fa-lightbulb"></i> ä½ çš„ä¿®æ”¹å»ºè®®
            </label>
            <textarea id="ai-suggestion-input" class="w-full p-3 border-2 border-purple-300 rounded-lg text-sm resize-none" rows="4" placeholder="ä¾‹å¦‚ï¼šå¢åŠ æ›´å¤šæƒ…æ„Ÿæå†™ã€æ”¹æˆæ‚²ä¼¤çš„è¯­æ°”ã€åŠ å…¥ç«¥å¹´å›å¿†çš„ç»†èŠ‚..."></textarea>
          </div>
          
          <div class="flex justify-between pt-4 border-t">
            <button onclick="showModifyOptions()" class="text-slate-400 hover:text-slate-600 px-4 py-2 text-sm">
              <i class="fa-solid fa-arrow-left"></i> è¿”å›
            </button>
            <button onclick="regenerateWithSuggestion()" class="bg-purple-600 hover:bg-purple-700 text-white px-6 py-2 rounded-lg text-sm font-medium">
              <i class="fa-solid fa-magic"></i> è®© AI é‡æ–°ç”Ÿæˆ
            </button>
          </div>
        </div>
      `;
    }

    function saveManualEdit() {
      const editedContent = document.getElementById('manual-edit-content').value.trim();
      const q = currentQuestions[currentQuestionIndex];
      questionAnswers[q.id] = {
        category: q.category,
        question: q.question,
        userAnswer: window.currentUserAnswer,
        answer: editedContent,
        source: 'manual-edit'
      };
      updateLog();
      showCompletionSummary();
    }

    async function regenerateWithSuggestion() {
      const suggestion = document.getElementById('ai-suggestion-input').value.trim();
      if(!suggestion) {
        alert('è¯·è¾“å…¥ä½ çš„ä¿®æ”¹å»ºè®®');
        return;
      }
      
      const container = document.getElementById('test-container');
      container.innerHTML = `
        <div class="bg-white p-6 rounded-xl shadow-sm border-2 border-purple-300">
          <div class="bg-slate-50 p-6 rounded-lg text-center">
            <i class="fa-solid fa-spinner fa-spin text-3xl text-purple-600 mb-3"></i>
            <p class="text-sm text-slate-600">AI æ­£åœ¨æ ¹æ®ä½ çš„å»ºè®®é‡æ–°ç”Ÿæˆ...</p>
          </div>
        </div>
      `;
      
      try {
        const q = currentQuestions[currentQuestionIndex];
        const prompt = `${q.context}\n\né—®é¢˜ï¼š${q.question}\n\nç”¨æˆ·çš„å›ç­”ï¼š${window.currentUserAnswer}\n\nä¹‹å‰ç”Ÿæˆçš„å†…å®¹ï¼š${window.currentAIGenerated}\n\nç”¨æˆ·çš„ä¿®æ”¹å»ºè®®ï¼š${suggestion}\n\nè¯·æ ¹æ®ç”¨æˆ·çš„ä¿®æ”¹å»ºè®®ï¼Œé‡æ–°ç”Ÿæˆä¸€æ®µ150-200å­—çš„è¯¦ç»†æè¿°ã€‚`;
        const newGenerated = await callAIText(prompt);
        showAIGeneratedContent(window.currentUserAnswer, newGenerated);
      } catch(e) {
        alert('AI ç”Ÿæˆå¤±è´¥ï¼š' + e.message);
      }
    }

    function approveContent() {
      const q = currentQuestions[currentQuestionIndex];
      questionAnswers[q.id] = {
        category: q.category,
        question: q.question,
        userAnswer: window.currentUserAnswer,
        answer: window.currentAIGenerated,
        source: 'approved'
      };
      updateLog();
      showCompletionSummary();
    }

    function showCompletionSummary() {
      const container = document.getElementById('test-container');
      container.innerHTML = `
        <div class="bg-green-100 p-6 rounded-xl border border-green-300 text-center">
          <i class="fa-solid fa-check-circle text-green-600 text-3xl mb-2"></i>
          <h3 class="text-lg font-bold text-green-900 mb-1">æµ‹è¯•å®Œæˆï¼</h3>
          <p class="text-sm text-green-700">æŸ¥çœ‹ä¸‹æ–¹çš„ç­”æ¡ˆè®°å½•</p>
        </div>
      `;
    }

    async function callAIText(prompt) {
      const apiUrl = document.getElementById('api-url').value;
      const apiKey = document.getElementById('api-key').value;
      
      const res = await fetch(`${apiUrl}/chat/completions`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${apiKey}`
        },
        body: JSON.stringify({
          model: 'deepseek-chat',
          messages: [{role: "user", content: prompt}],
          temperature: 0.8
        })
      });
      
      if(!res.ok) throw new Error(`HTTP ${res.status}`);
      const data = await res.json();
      return data.choices[0].message.content.trim();
    }

    function updateLog() {
      document.getElementById('log-content').innerHTML = JSON.stringify(questionAnswers, null, 2);
    }
  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>çµæ„Ÿé“¸é€ å‚ V7.0 - Ultimate Edition</title>
<script src="https://cdn.tailwindcss.com"></script>
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
<style>
@import url('https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@300;400;500;700&display=swap');
@import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&display=swap');
body { font-family: 'Noto Sans SC', sans-serif; background-color: #f1f5f9; }
.step-panel { display: none; opacity: 0; transition: opacity 0.3s ease-in-out; }
.step-panel.active { display: block; opacity: 1; }
.option-btn { transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1); }
.option-btn:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
.option-btn:active:not(:disabled) { transform: translateY(0); }
.option-btn.selected { background-color: #0f172a; color: white; border-color: #0f172a; box-shadow: 0 0 0 2px #94a3b8; }
.ai-loading { animation: pulse-blue 1.5s infinite; pointer-events: none; opacity: 0.7; }
@keyframes pulse-blue { 0% { opacity: 0.6; } 50% { opacity: 1; } 100% { opacity: 0.6; } }
.dot-group { display: flex; gap: 3px; cursor: pointer; }
.dot { width: 12px; height: 12px; border-radius: 50%; border: 1px solid #94a3b8; background-color: white; transition: all 0.1s;}
.dot.active { background-color: #334155; border-color: #334155; }
.dot:hover { border-color: #64748b; background-color: #e2e8f0; }
input[type=range].spectrum-slider {-webkit-appearance: none; width: 100%; background: transparent;}
input[type=range].spectrum-slider::-webkit-slider-thumb {-webkit-appearance: none; height: 14px; width: 14px;border-radius: 50%; background: #334155;cursor: pointer; margin-top: -5px;box-shadow: 0 0 0 2px white, 0 0 0 3px #cbd5e1;}
input[type=range].spectrum-slider::-webkit-slider-runnable-track {width: 100%; height: 4px; cursor: pointer;background: #e2e8f0; border-radius: 2px;}
.modal { transition: opacity 0.25s ease; }
body.modal-active { overflow: hidden; }
::-webkit-scrollbar { width: 6px; }
::-webkit-scrollbar-track { background: transparent; }
::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
</style>
</head>
<body class="h-screen flex flex-col text-slate-800 overflow-hidden">
<!-- Header -->
<header class="bg-white border-b border-slate-200 z-20 flex-none shadow-sm">
<div class="max-w-7xl mx-auto px-4 py-3 flex justify-between items-center">
<div class="flex items-center gap-3">
<div class="w-9 h-9 bg-slate-800 rounded-lg flex items-center justify-center text-white shadow-lg">
<i class="fa-solid fa-drafting-compass"></i>
</div>
<div>
<h1 class="font-bold text-lg leading-tight tracking-tight">çµæ„Ÿé“¸é€ å‚ <span class="text-slate-500 text-xs align-top">V7.0</span></h1>
<div class="text-[10px] text-slate-400 font-mono flex items-center gap-1 cursor-pointer hover:text-slate-600" onclick="toggleSettings()">
<span id="header-status-dot" class="w-2 h-2 rounded-full bg-slate-300"></span>
<span id="header-status-text">éœ€é…ç½® AI</span>
</div>
</div>
</div>
<div class="flex items-center gap-4">
<div class="hidden md:flex items-center gap-2 text-xs font-semibold text-slate-400 mr-4">
<span id="step-dot-1" class="text-slate-800">1.åŸºç¡€æ¡£æ¡ˆ</span> <i class="fa-solid fa-chevron-right text-[10px]"></i>
<span id="step-dot-2">2.å¤–è²Œç»†åŒ–</span> <i class="fa-solid fa-chevron-right text-[10px]"></i>
<span id="step-dot-3">3.ç²¾ç¥ç‰¹è´¨</span> <i class="fa-solid fa-chevron-right text-[10px]"></i>
<span id="step-dot-4">4.æ·±åº¦ç»†åŒ–</span> <i class="fa-solid fa-chevron-right text-[10px]"></i>
<span id="step-dot-5">5.æœ€ç»ˆæŠ¥å‘Š</span>
</div>
<div class="flex gap-2">
<button onclick="exportCharacter()" class="text-slate-500 hover:text-slate-800 transition p-2 rounded-full hover:bg-slate-100" title="å¯¼å‡ºè§’è‰²">
<i class="fa-solid fa-download text-lg"></i>
</button>
<button onclick="importCharacter()" class="text-slate-500 hover:text-slate-800 transition p-2 rounded-full hover:bg-slate-100" title="å¯¼å…¥è§’è‰²">
<i class="fa-solid fa-upload text-lg"></i>
</button>
<button onclick="toggleSettings()" class="text-slate-500 hover:text-slate-800 transition p-2 rounded-full hover:bg-slate-100 relative group" title="API è®¾ç½®">
<i class="fa-solid fa-gear text-lg"></i>
<span class="absolute top-0 right-0 w-2 h-2 bg-red-500 rounded-full hidden" id="config-alert-dot"></span>
</button>
</div>
</div>
</div>
</header>

<!-- Main Content -->
<div class="flex-1 flex overflow-hidden max-w-7xl mx-auto w-full relative">
<!-- Left: Workbench -->
<main class="flex-1 overflow-y-auto p-4 md:p-6 w-full md:w-2/3 relative bg-slate-50" id="main-scroll">
<!-- Step 1: Character Sheet -->
<div id="step-1" class="step-panel active max-w-4xl mx-auto space-y-6 pb-24">
<div class="flex justify-between items-end mb-2">
<div>
<h2 class="text-2xl font-bold text-slate-800">è§’è‰²æ ¸å¿ƒæ¡£æ¡ˆ</h2>
<p class="text-slate-500 text-sm">å®šä¹‰è§’è‰²çš„å†…åœ¨æ•°å€¼ä¸æ€§æ ¼å€¾å‘ã€‚</p>
</div>
<button onclick="randomizeSheet()" class="text-sm bg-white border border-slate-200 text-slate-600 hover:bg-slate-50 hover:border-slate-300 px-3 py-1.5 rounded-lg transition shadow-sm font-medium flex items-center gap-2">
<i class="fa-solid fa-dice text-slate-400"></i> éšæœºæ•°å€¼
</button>
</div>

<!-- Basic Info Grid -->
<div class="bg-white p-5 rounded-xl shadow-sm border border-slate-200">
<h3 class="text-xs font-bold text-slate-400 uppercase mb-4 tracking-wider border-b pb-2">åŸºç¡€ä¿¡æ¯</h3>
<div class="grid grid-cols-2 md:grid-cols-6 gap-4">
<div class="col-span-2 md:col-span-3">
<label class="block text-[10px] font-bold text-slate-500 mb-1 uppercase">å§“å</label>
<div class="flex gap-2">
<input type="text" id="input-name" class="w-full text-sm border-slate-300 rounded focus:border-slate-500 focus:ring-0 py-1.5 px-2 bg-slate-50" placeholder="è§’è‰²å§“å">
<button onclick="generateSingleField('name')" class="px-3 bg-slate-800 hover:bg-black text-white rounded text-xs flex items-center gap-1 min-w-[80px] justify-center">
<i class="fa-solid fa-magic"></i> ç”Ÿæˆ
</button>
</div>
</div>
<div class="col-span-1">
<label class="block text-[10px] font-bold text-slate-500 mb-1 uppercase">æ€§åˆ«</label>
<select id="input-gender" class="w-full text-sm border-slate-300 rounded focus:border-slate-500 focus:ring-0 py-1.5 bg-slate-50">
<option value="ç”·">ç”·</option>
<option value="å¥³">å¥³</option>
<option value="æ— æ€§">æ— æ€§</option>
<option value="å…¶ä»–">å…¶ä»–</option>
</select>
</div>
<div class="col-span-1">
<label class="block text-[10px] font-bold text-slate-500 mb-1 uppercase">å¹´é¾„</label>
<input type="number" id="input-age" class="w-full text-sm border-slate-300 rounded focus:border-slate-500 focus:ring-0 py-1.5 px-2 bg-slate-50" placeholder="20">
</div>
<div class="col-span-1">
<label class="block text-[10px] font-bold text-slate-500 mb-1 uppercase">èº«é«˜(cm)</label>
<input type="number" id="input-height" class="w-full text-sm border-slate-300 rounded focus:border-slate-500 focus:ring-0 py-1.5 px-2 bg-slate-50" placeholder="170">
</div>
<div class="col-span-2">
<label class="block text-[10px] font-bold text-slate-500 mb-1 uppercase">ç§æ—</label>
<div class="flex gap-2">
<input type="text" id="input-race" class="w-full text-sm border-slate-300 rounded focus:border-slate-500 focus:ring-0 py-1.5 px-2 bg-slate-50" placeholder="äººç±»">
<button onclick="generateSingleField('race')" class="px-2 bg-slate-100 hover:bg-slate-200 rounded text-slate-500 text-xs">
<i class="fa-solid fa-magic"></i>
</button>
</div>
</div>
<div class="col-span-2">
<label class="block text-[10px] font-bold text-slate-500 mb-1 uppercase">é˜µè¥</label>
<select id="input-alignment" class="w-full text-sm border-slate-300 rounded focus:border-slate-500 focus:ring-0 py-1.5 bg-slate-50">
<option value="å®ˆåºå–„è‰¯">å®ˆåºå–„è‰¯</option>
<option value="ä¸­ç«‹å–„è‰¯">ä¸­ç«‹å–„è‰¯</option>
<option value="æ··ä¹±å–„è‰¯">æ··ä¹±å–„è‰¯</option>
<option value="å®ˆåºä¸­ç«‹">å®ˆåºä¸­ç«‹</option>
<option value="ç»å¯¹ä¸­ç«‹">ç»å¯¹ä¸­ç«‹</option>
<option value="æ··ä¹±ä¸­ç«‹">æ··ä¹±ä¸­ç«‹</option>
<option value="å®ˆåºé‚ªæ¶">å®ˆåºé‚ªæ¶</option>
<option value="ä¸­ç«‹é‚ªæ¶">ä¸­ç«‹é‚ªæ¶</option>
<option value="æ··ä¹±é‚ªæ¶">æ··ä¹±é‚ªæ¶</option>
</select>
</div>
<div class="col-span-2 md:col-span-6">
<label class="block text-[10px] font-bold text-slate-500 mb-1 uppercase">æ ¸å¿ƒèº«ä»½ / èŒä¸š</label>
<div class="flex gap-2">
<input type="text" id="input-archetype" class="w-full text-sm border-slate-300 rounded focus:border-slate-500 focus:ring-0 py-1.5 px-2 bg-slate-50" placeholder="ä¾‹å¦‚ï¼šè½é­„çš„èµ›åšä¾¦æ¢">
<button onclick="generateSingleField('archetype')" class="px-3 bg-slate-800 hover:bg-black text-white rounded text-xs flex items-center gap-1 min-w-[80px] justify-center">
<i class="fa-solid fa-magic"></i> ç”Ÿæˆ
</button>
</div>
</div>
</div>
</div>

<!-- Attributes & Personality -->
<div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
<div class="bg-white p-5 rounded-xl shadow-sm border border-slate-200">
<h3 class="text-xs font-bold text-slate-400 uppercase mb-4 tracking-wider border-b pb-2">ä¸ªäººç‰¹è´¨ (Attributes)</h3>
<div class="grid grid-cols-2 gap-x-8 gap-y-3" id="attributes-container"></div>
</div>
<div class="bg-white p-5 rounded-xl shadow-sm border border-slate-200">
<h3 class="text-xs font-bold text-slate-400 uppercase mb-4 tracking-wider border-b pb-2">æ€§æ ¼å€¾å‘ (Personality)</h3>
<div class="space-y-3" id="personality-container"></div>
</div>
</div>

<div class="flex justify-end pt-4">
<button onclick="finishStep1()" class="bg-slate-900 hover:bg-black text-white px-8 py-3 rounded-xl font-bold shadow-lg shadow-slate-300 transition flex items-center gap-2 group">
<span>ç¡®è®¤å¹¶ç”Ÿæˆå¤–è²Œ</span> <i class="fa-solid fa-arrow-right group-hover:translate-x-1 transition-transform"></i>
</button>
</div>
</div>

<!-- Step 2: Visuals -->
<div id="step-2" class="step-panel max-w-4xl mx-auto space-y-6 pb-24">
<div class="flex justify-between items-center mb-4">
<div>
<h2 class="text-2xl font-bold text-slate-800">å¤–è²Œå…·è±¡åŒ–</h2>
<p class="text-xs text-slate-500 mt-1">ğŸ’¡ æç¤ºï¼šå¤§éƒ¨åˆ†ç±»åˆ«å¯ä»¥é€‰æ‹©å¤šä¸ªé€‰é¡¹ï¼ˆç‚¹å‡»å¤šæ¬¡ï¼‰</p>
</div>
<div class="text-xs text-slate-500 bg-white px-3 py-1 rounded-full border">åŸºäºæœ¬åœ°é¢„è®¾ + AI æ¨æ¼”</div>
</div>

<!-- Hair System -->
<div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200">
<div class="flex justify-between items-center mb-4">
<h3 class="text-sm font-bold text-slate-700 uppercase tracking-wider">
<i class="fa-solid fa-user-tag mr-2 text-slate-400"></i> å‘å‹ç‰¹å¾
</h3>
<button onclick="refreshVisuals('hair')" class="text-xs text-blue-600 hover:underline">å…¨éƒ¨é‡éš</button>
</div>
<div class="grid grid-cols-1 md:grid-cols-3 gap-6">
<div>
<span class="text-[10px] font-bold text-slate-400 uppercase block mb-2">1. é•¿åº¦ (Length)</span>
<div class="flex flex-wrap gap-2" id="opt-hair-length"></div>
</div>
<div>
<span class="text-[10px] font-bold text-slate-400 uppercase block mb-2">2. è´¨æ„Ÿ/é€ å‹ (Texture)</span>
<div class="flex flex-wrap gap-2" id="opt-hair-style"></div>
</div>
<div>
<span class="text-[10px] font-bold text-slate-400 uppercase block mb-2">3. é¢œè‰² (Color)</span>
<div class="flex flex-wrap gap-2" id="opt-hair-color"></div>
</div>
</div>
</div>

<!-- Face & Eyes -->
<div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200">
<h3 class="text-sm font-bold text-slate-700 uppercase tracking-wider mb-4">
<i class="fa-solid fa-eye mr-2 text-slate-400"></i> é¢éƒ¨ä¸çœ¼ç›
</h3>
<div class="grid grid-cols-1 md:grid-cols-2 gap-6">
<div>
<span class="text-[10px] font-bold text-slate-400 uppercase block mb-2">çœ¼å‹ (Shape)</span>
<div class="flex flex-wrap gap-2" id="opt-eye-shape"></div>
</div>
<div>
<span class="text-[10px] font-bold text-slate-400 uppercase block mb-2">ç³è‰² (Iris Color)</span>
<div class="flex flex-wrap gap-2" id="opt-eye-color"></div>
</div>
<div>
<span class="text-[10px] font-bold text-slate-400 uppercase block mb-2">è„¸å‹ (Face Shape)</span>
<div class="flex flex-wrap gap-2" id="opt-face-structure"></div>
</div>
<div>
<span class="text-[10px] font-bold text-slate-400 uppercase block mb-2">è‚¤è‰² (Skin Tone)</span>
<div class="flex flex-wrap gap-2" id="opt-skin-tone"></div>
</div>
<div>
<span class="text-[10px] font-bold text-slate-400 uppercase block mb-2">ç‰¹æ®Šæ ‡è®° (Marks)</span>
<div class="flex flex-wrap gap-2" id="opt-special-marks"></div>
</div>
<div>
<span class="text-[10px] font-bold text-slate-400 uppercase block mb-2">é¢éƒ¨ç‰¹å¾ (Feature)</span>
<div class="flex flex-wrap gap-2" id="opt-face-feature"></div>
</div>
</div>
</div>

<!-- Body & Clothing -->
<div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200">
<h3 class="text-sm font-bold text-slate-700 uppercase tracking-wider mb-4">
<i class="fa-solid fa-shirt mr-2 text-slate-400"></i> èº«æä¸ç©¿æ­
</h3>
<div class="grid grid-cols-1 md:grid-cols-2 gap-6">
<div>
<span class="text-[10px] font-bold text-slate-400 uppercase block mb-2">ä½“å‹ (Build)</span>
<div class="flex flex-wrap gap-2" id="opt-body-build"></div>
</div>
<div>
<span class="text-[10px] font-bold text-slate-400 uppercase block mb-2">é…é¥° (Accessories)</span>
<div class="flex flex-wrap gap-2" id="opt-accessories"></div>
</div>
<div>
<span class="text-[10px] font-bold text-slate-400 uppercase block mb-2">ç©¿æ­é£æ ¼ (Style)</span>
<div class="flex flex-wrap gap-2" id="opt-cloth-style"></div>
</div>
<div>
<span class="text-[10px] font-bold text-slate-400 uppercase block mb-2">æ ‡å¿—å•å“ (Item)</span>
<div class="flex flex-wrap gap-2" id="opt-cloth-item"></div>
</div>
</div>
</div>

<div class="flex justify-between pt-4">
<button onclick="goToStep(1)" class="text-slate-400 hover:text-slate-600 px-4 py-2 font-medium">è¿”å›ä¿®æ”¹æ•°å€¼</button>
<button onclick="finishStep2()" class="bg-slate-900 hover:bg-black text-white px-8 py-3 rounded-xl font-bold shadow-lg shadow-slate-300 transition flex items-center gap-2 group">
<span>ä¸‹ä¸€æ­¥:æ³¨å…¥çµé­‚</span> <i class="fa-solid fa-arrow-right group-hover:translate-x-1 transition-transform"></i>
</button>
</div>
</div>

<!-- Step 3: Soul & Details -->
<div id="step-3" class="step-panel max-w-4xl mx-auto space-y-6 pb-24">
<div class="bg-slate-100 p-6 rounded-xl border border-slate-200 mb-6">
<div class="flex gap-3 items-start">
<i class="fa-solid fa-ghost text-slate-400 text-xl mt-1"></i>
<div>
<h3 class="font-bold text-slate-800 text-sm">AI æ·±åº¦æ¨æ¼”</h3>
<p class="text-xs text-slate-500 mt-1">æ ¹æ®ã€<span id="summary-archetype" class="font-bold"></span>ã€‘çš„è®¾å®šï¼ŒAI é¢„æµ‹äº†ä»¥ä¸‹æ·±å±‚ç‰¹å¾ã€‚</p>
<p class="text-xs text-purple-600 mt-1">ğŸ’¡ å¯ä»¥é€‰æ‹©å¤šä¸ªé€‰é¡¹</p>
</div>
</div>
</div>

<div class="grid grid-cols-1 md:grid-cols-2 gap-6">
<div class="bg-white p-5 rounded-xl shadow-sm border border-slate-200">
<h3 class="text-xs font-bold text-slate-400 uppercase mb-3 tracking-wider">ç²¾ç¥çŠ¶æ€</h3>
<div class="mb-4">
<span class="text-[10px] text-slate-400 block mb-1">ææƒ§çš„äº‹ç‰©</span>
<div class="flex flex-wrap gap-2" id="opt-fear"></div>
</div>
<div>
<span class="text-[10px] text-slate-400 block mb-1">å¿ƒç†é˜´å½±/åˆ›ä¼¤</span>
<div class="flex flex-wrap gap-2" id="opt-trauma"></div>
</div>
</div>

<div class="bg-white p-5 rounded-xl shadow-sm border border-slate-200">
<h3 class="text-xs font-bold text-slate-400 uppercase mb-3 tracking-wider">ä¸ªäººå–œå¥½</h3>
<div class="mb-4">
<span class="text-[10px] text-slate-400 block mb-1">å–œçˆ±çš„äº‹ç‰©</span>
<div class="flex flex-wrap gap-2" id="opt-likes"></div>
</div>
<div>
<span class="text-[10px] text-slate-400 block mb-1">åŒæ¶çš„äº‹ç‰©</span>
<div class="flex flex-wrap gap-2" id="opt-dislikes"></div>
</div>
</div>
</div>

<div class="bg-white p-5 rounded-xl shadow-sm border border-slate-200">
<h3 class="text-xs font-bold text-slate-400 uppercase mb-3 tracking-wider">ç¤¾ä¼šè¯„ä»· & éšèº«ç‰©å“</h3>
<div class="grid grid-cols-1 md:grid-cols-2 gap-6">
<div>
<span class="text-[10px] text-slate-400 block mb-1">ç¤¾ä¼šè¯„ä»·</span>
<div class="flex flex-wrap gap-2" id="opt-social"></div>
</div>
<div>
<span class="text-[10px] text-slate-400 block mb-1">é‡è¦éšèº«ç‰©</span>
<div class="flex flex-wrap gap-2" id="opt-items"></div>
</div>
</div>
</div>

<div class="flex justify-between pt-4">
<button onclick="goToStep(2)" class="text-slate-400 hover:text-slate-600 px-4 py-2 font-medium">è¿”å›ä¿®æ”¹å¤–è²Œ</button>
<button onclick="finishStep3()" class="bg-slate-900 hover:bg-black text-white px-8 py-3 rounded-xl font-bold shadow-lg shadow-slate-300 transition flex items-center gap-2 group">
<span>ä¸‹ä¸€æ­¥ï¼šæ·±åº¦ç»†åŒ–</span> <i class="fa-solid fa-arrow-right group-hover:translate-x-1 transition-transform"></i>
</button>
</div>
</div>

<!-- Step 4: Deep Details -->
<div id="step-4" class="step-panel max-w-4xl mx-auto space-y-6 pb-24">
<div class="bg-gradient-to-r from-purple-100 to-blue-100 p-6 rounded-xl border border-purple-200 mb-6">
<div class="flex gap-3 items-start">
<i class="fa-solid fa-brain text-purple-600 text-xl mt-1"></i>
<div>
<h3 class="font-bold text-purple-900 text-sm">AI æ·±åº¦ç»†åŒ–</h3>
<p class="text-xs text-purple-700 mt-1">AI æ­£åœ¨æ ¹æ®ä½ çš„é€‰æ‹©ç”Ÿæˆå…·ä½“ç»†èŠ‚...</p>
</div>
</div>
</div>

<div id="deep-details-container" class="space-y-4"></div>

<div class="flex justify-between pt-4">
<button onclick="goToStep(3)" class="text-slate-400 hover:text-slate-600 px-4 py-2 font-medium">è¿”å›ä¿®æ”¹ç‰¹è´¨</button>
<button onclick="finishStep4()" class="bg-purple-600 hover:bg-purple-700 text-white px-8 py-3 rounded-xl font-bold shadow-lg shadow-purple-200 transition flex items-center gap-2 group">
<span>ç”Ÿæˆæœ€ç»ˆæŠ¥å‘Š</span> <i class="fa-solid fa-arrow-right group-hover:translate-x-1 transition-transform"></i>
</button>
</div>
</div>

<!-- Step 5: Final Report -->
<div id="step-5" class="step-panel max-w-4xl mx-auto space-y-6 pb-24">
<div class="bg-gradient-to-r from-green-100 to-emerald-100 p-6 rounded-xl border border-green-200 mb-6">
<div class="flex gap-3 items-start">
<i class="fa-solid fa-file-contract text-green-600 text-xl mt-1"></i>
<div>
<h3 class="font-bold text-green-900 text-sm">æœ€ç»ˆæŠ¥å‘Šç”Ÿæˆ</h3>
<p class="text-xs text-green-700 mt-1">é€‰æ‹©æŠ¥å‘Šæ ¼å¼ï¼ŒAI å°†ç”Ÿæˆå®Œæ•´çš„è§’è‰²æ¡£æ¡ˆ</p>
</div>
</div>
</div>

<div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200">
<h3 class="text-sm font-bold text-slate-700 mb-4">é€‰æ‹©æŠ¥å‘Šæ ¼å¼</h3>
<div class="grid grid-cols-1 md:grid-cols-3 gap-4">
<button onclick="generateReport('novel')" class="p-4 border-2 border-slate-200 rounded-xl hover:border-blue-500 hover:bg-blue-50 transition text-left">
<div class="flex items-center gap-3 mb-2">
<i class="fa-solid fa-book text-blue-500 text-xl"></i>
<span class="font-bold text-slate-800">å°è¯´é£æ ¼</span>
</div>
<p class="text-xs text-slate-500">å™äº‹æ€§æè¿°ï¼Œé€‚åˆåˆ›ä½œå‚è€ƒ</p>
</button>
<button onclick="generateReport('rpg')" class="p-4 border-2 border-slate-200 rounded-xl hover:border-purple-500 hover:bg-purple-50 transition text-left">
<div class="flex items-center gap-3 mb-2">
<i class="fa-solid fa-dice-d20 text-purple-500 text-xl"></i>
<span class="font-bold text-slate-800">TRPG å¡ç‰‡</span>
</div>
<p class="text-xs text-slate-500">ç»“æ„åŒ–æ•°æ®ï¼Œé€‚åˆè·‘å›¢ä½¿ç”¨</p>
</button>
<button onclick="generateReport('profile')" class="p-4 border-2 border-slate-200 rounded-xl hover:border-green-500 hover:bg-green-50 transition text-left">
<div class="flex items-center gap-3 mb-2">
<i class="fa-solid fa-id-card text-green-500 text-xl"></i>
<span class="font-bold text-slate-800">æ¡£æ¡ˆæŠ¥å‘Š</span>
</div>
<p class="text-xs text-slate-500">å®˜æ–¹æ–‡æ¡£é£æ ¼ï¼Œè¯¦ç»†è®°å½•</p>
</button>
<button onclick="generateReport('interview')" class="p-4 border-2 border-slate-200 rounded-xl hover:border-orange-500 hover:bg-orange-50 transition text-left">
<div class="flex items-center gap-3 mb-2">
<i class="fa-solid fa-comments text-orange-500 text-xl"></i>
<span class="font-bold text-slate-800">è®¿è°ˆè®°å½•</span>
</div>
<p class="text-xs text-slate-500">å¯¹è¯å½¢å¼ï¼Œå±•ç°æ€§æ ¼</p>
</button>
<button onclick="generateReport('diary')" class="p-4 border-2 border-slate-200 rounded-xl hover:border-pink-500 hover:bg-pink-50 transition text-left">
<div class="flex items-center gap-3 mb-2">
<i class="fa-solid fa-book-open text-pink-500 text-xl"></i>
<span class="font-bold text-slate-800">æ—¥è®°ä½“</span>
</div>
<p class="text-xs text-slate-500">ç¬¬ä¸€äººç§°ï¼Œå†…å¿ƒç‹¬ç™½</p>
</button>
<button onclick="generateReport('medical')" class="p-4 border-2 border-slate-200 rounded-xl hover:border-red-500 hover:bg-red-50 transition text-left">
<div class="flex items-center gap-3 mb-2">
<i class="fa-solid fa-file-medical text-red-500 text-xl"></i>
<span class="font-bold text-slate-800">åŒ»ç–—æ¡£æ¡ˆ</span>
</div>
<p class="text-xs text-slate-500">ä¸“ä¸šæœ¯è¯­ï¼Œç§‘å­¦è®°å½•</p>
</button>
</div>
</div>

<div id="report-display" class="hidden mt-6">
<div class="bg-white p-8 rounded-xl shadow-lg border border-slate-200">
<div class="flex justify-between items-start mb-6">
<div>
<h3 class="text-xl font-bold text-slate-800 mb-1" id="report-title">è§’è‰²æŠ¥å‘Š</h3>
<p class="text-xs text-slate-500">ç”Ÿæˆæ—¶é—´ï¼š<span id="report-time"></span></p>
</div>
<div class="flex gap-2">
<button onclick="copyReport()" class="text-xs bg-slate-100 hover:bg-slate-200 px-3 py-2 rounded-lg border border-slate-300 transition">
<i class="fa-regular fa-copy"></i> å¤åˆ¶
</button>
<button onclick="downloadReport()" class="text-xs bg-blue-600 hover:bg-blue-700 text-white px-3 py-2 rounded-lg transition">
<i class="fa-solid fa-download"></i> ä¸‹è½½
</button>
</div>
</div>
<div id="report-content" class="text-slate-700 leading-relaxed whitespace-pre-wrap" style="font-family: serif;"></div>
</div>
</div>

<div class="flex justify-between pt-4">
<button onclick="goToStep(4)" class="text-slate-400 hover:text-slate-600 px-4 py-2 font-medium">è¿”å›ç»†åŒ–</button>
<button onclick="goToStep(1)" class="bg-slate-600 hover:bg-slate-700 text-white px-6 py-3 rounded-xl font-bold transition">
<i class="fa-solid fa-rotate-left"></i> é‡æ–°å¼€å§‹
</button>
</div>
</div>

</main>

<!-- Right: Preview -->
<aside class="hidden lg:block w-80 bg-white border-l border-slate-200 p-6 z-10 flex flex-col">
<h3 class="font-bold text-slate-800 mb-4 flex items-center gap-2">
<i class="fa-regular fa-id-card text-slate-400"></i> å®æ—¶æ¡£æ¡ˆ
</h3>
<div id="preview-card" class="bg-slate-50 rounded-lg p-5 border border-slate-200 text-sm space-y-4 flex-1 overflow-y-auto font-mono text-xs">
<div class="border-b border-slate-200 pb-3">
<div class="text-[10px] uppercase text-slate-400 font-bold mb-1">IDENTITY</div>
<div class="font-bold text-base text-slate-800 mb-1" id="p-name">æœªå‘½å</div>
<div class="flex justify-between items-baseline">
<span class="font-bold text-sm text-slate-700" id="p-archetype">???</span>
<span class="text-slate-500" id="p-gender">-</span>
</div>
<div class="mt-1 flex gap-2 text-slate-500 text-[10px]">
<span id="p-race">ç§æ—: ?</span> | <span id="p-age">Age: ?</span> | <span id="p-height">H: ?</span>
</div>
<div class="mt-1 text-slate-500" id="p-alignment">é˜µè¥: ?</div>
</div>
<div class="border-b border-slate-200 pb-3">
<div class="text-[10px] uppercase text-slate-400 font-bold mb-2">STATS</div>
<div class="grid grid-cols-2 gap-y-1 gap-x-2" id="p-stats"></div>
</div>
<div class="border-b border-slate-200 pb-3">
<div class="text-[10px] uppercase text-slate-400 font-bold mb-2">PERSONALITY</div>
<div class="space-y-1" id="p-personality"></div>
</div>
<div>
<div class="text-[10px] uppercase text-slate-400 font-bold mb-2">VISUALS</div>
<ul class="space-y-1 text-slate-600 list-disc list-inside" id="p-visuals">
<li class="italic text-slate-300">ç­‰å¾…ç”Ÿæˆ...</li>
</ul>
</div>
<div class="border-t border-slate-200 pt-3 mt-3">
<div class="text-[10px] uppercase text-slate-400 font-bold mb-2">SOUL</div>
<div class="flex flex-wrap gap-1" id="p-soul"></div>
</div>
</div>
</aside>
</div>

<!-- API Settings Modal -->
<div id="settings-modal" class="modal opacity-0 pointer-events-none fixed inset-0 z-50 flex items-center justify-center">
<div class="absolute inset-0 bg-slate-900/40 backdrop-blur-sm" onclick="toggleSettings()"></div>
<div class="bg-white rounded-2xl shadow-2xl w-full max-w-md p-6 relative z-10 transform transition-all scale-95" id="modal-content">
<h2 class="text-xl font-bold mb-1">API è®¾ç½®</h2>
<div class="space-y-4 mt-4">
<div>
<label class="block text-xs font-bold text-slate-700 uppercase mb-2">æœåŠ¡å•†é¢„è®¾</label>
<select id="api-preset" onchange="applyPreset()" class="w-full px-4 py-2 rounded-lg border border-slate-300 text-sm bg-slate-50">
<option value="openai">OpenAI (Official)</option>
<option value="gemini" selected>Google Gemini</option>
<option value="deepseek">DeepSeek</option>
<option value="custom">Custom</option>
</select>
</div>
<div>
<label class="block text-xs font-bold text-slate-700 uppercase mb-2">Endpoint URL</label>
<input type="text" id="api-url" oninput="updateUrlPreview()" class="w-full px-4 py-2 rounded-lg border border-slate-300 text-sm font-mono" value="https://generativelanguage.googleapis.com/v1beta/openai">
</div>
<div>
<label class="block text-xs font-bold text-slate-700 uppercase mb-2">API Key</label>
<input type="password" id="api-key" class="w-full px-4 py-2 rounded-lg border border-slate-300 text-sm font-mono">
</div>
<div>
<label class="block text-xs font-bold text-slate-700 uppercase mb-2">Model Name</label>
<input list="model-suggestions" type="text" id="api-model" class="w-full px-4 py-2 rounded-lg border border-slate-300 text-sm font-mono" value="gemini-2.0-flash">
<datalist id="model-suggestions">
<option value="gemini-2.0-flash">
<option value="gemini-1.5-flash">
<option value="gemini-1.5-pro">
<option value="gpt-3.5-turbo">
<option value="gpt-4o">
<option value="deepseek-chat">
</datalist>
</div>
<div class="bg-slate-100 rounded px-3 py-2 text-[10px] text-slate-500 font-mono break-all">
<span class="font-bold text-slate-400">Request URL:</span> <span id="url-preview">...</span>
</div>
<div class="bg-slate-50 rounded-lg p-3 border border-slate-200 flex flex-col justify-between">
<div class="flex justify-between items-center w-full mb-2">
<div class="text-xs font-bold text-slate-700">è¿é€šæ€§æµ‹è¯•</div>
<button onclick="testConnection()" id="btn-test-conn" class="text-xs bg-white border border-slate-300 px-3 py-1.5 rounded shadow-sm">æµ‹è¯•è¿æ¥</button>
</div>
<div id="test-status-text" class="text-xs text-slate-400 mb-1"></div>
<div id="debug-error-box" class="hidden text-[10px] font-mono bg-red-50 text-red-700 p-2 rounded border border-red-100 break-all"></div>
</div>
</div>
<div class="mt-6 flex justify-end gap-3">
<button onclick="toggleSettings()" class="px-4 py-2 text-slate-500 hover:bg-slate-100 rounded-lg text-sm">å…³é—­</button>
<button onclick="saveSettings()" class="px-6 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg text-sm shadow-md">ä¿å­˜</button>
</div>
</div>
</div>

<script>
// ===== LOCAL DATA PRESETS =====
const LOCAL_PRESETS = {
  'hair-length': ['å¯¸å¤´', 'è¶…çŸ­å‘', 'çŸ­å‘', 'é½è€³', 'é½è‚©', 'ä¸­é•¿å‘', 'åŠè…°', 'åŠè†', 'æ‹–åœ°é•¿å‘'],
  'hair-color': ['é»‘è‰²', 'æ·±æ£•', 'æµ…æ£•', 'é‡‘è‰²', 'é“¶ç™½', 'ç°è‰²', 'çº¢è‰²', 'é…’çº¢', 'è“è‰²', 'æ·±è“', 'ç´«è‰²', 'ç²‰è‰²', 'æ¸å˜è‰²', 'æŒ‘æŸ“'],
  'hair-style': ['ç›´å‘', 'å¾®å·', 'å¤§æ³¢æµª', 'å°å·', 'çˆ†ç‚¸å¤´', 'åˆºçŒ¬å¤´', 'å‡Œä¹±', 'å…‰æ»‘', 'é©¬å°¾', 'åŒé©¬å°¾', 'ä¸¸å­å¤´', 'éº»èŠ±è¾«', 'å…¬ä¸»åˆ‡', 'ä¸­åˆ†', 'ååˆ†', 'åˆ˜æµ·'],
  'eye-color': ['é»‘è‰²', 'æ·±æ£•', 'æµ…æ£•', 'è“è‰²', 'æ·±è“', 'ç»¿è‰²', 'ç¿ ç»¿', 'ç°è‰²', 'é“¶ç°', 'ç¥ç€è‰²', 'é‡‘è‰²', 'ç´«è‰²', 'çº¢è‰²', 'ç²‰è‰²', 'å¼‚è‰²ç³'],
  'eye-shape': ['æçœ¼', 'æ¡ƒèŠ±çœ¼', 'ä¸¹å‡¤çœ¼', 'åœ†çœ¼', 'ç‹ç‹¸çœ¼', 'ä¸‹å‚çœ¼', 'ä¸ŠæŒ‘çœ¼', 'ç»†é•¿çœ¼', 'ä¸‰è§’çœ¼', 'æ­»é±¼çœ¼'],
  'body-build': ['éª¨æ„Ÿ', 'çº¤ç˜¦', 'è‹—æ¡', 'åŒ€ç§°', 'å¥å£®', 'é­æ¢§', 'ä¸°æ»¡', 'å¾®èƒ–', 'çŸ®å°', 'å¨‡å°', 'é«˜æŒ‘', 'ä¿®é•¿', 'è‚Œè‚‰å‘è¾¾', 'å£®ç¡•'],
  'skin-tone': ['è‹ç™½', 'ç™½çš™', 'è±¡ç‰™ç™½', 'å°éº¦è‰²', 'å¥åº·è‚¤è‰²', 'å¤é“œè‰²', 'æ£•è‰²', 'æ·±æ£•', 'é»é»‘'],
  'facial-structure': ['é¹…è›‹è„¸', 'ç“œå­è„¸', 'åœ†è„¸', 'æ–¹è„¸', 'é•¿è„¸', 'è±å½¢è„¸', 'å¿ƒå½¢è„¸', 'å›½å­—è„¸'],
  'special-marks': ['æ— ', 'é›€æ–‘', 'ç¾äººç—£', 'æ³ªç—£', 'ç–¤ç—•', 'çº¹èº«', 'èƒè®°', 'é…’çª', 'æ¢¨æ¶¡'],
  'accessories': ['æ— ', 'çœ¼é•œ', 'å¢¨é•œ', 'è€³ç¯', 'é¡¹é“¾', 'æ‰‹è¡¨', 'æˆ’æŒ‡', 'å‘é¥°', 'å¸½å­', 'é¢å…·', 'çœ¼ç½©', 'ç»·å¸¦']
};

// ===== DEFINITIONS =====
const attributesList = [
  { id: 'stamina', label: 'ä½“åŠ›' }, { id: 'endurance', label: 'è€åŠ›' },
  { id: 'vision', label: 'è§†åŠ›' }, { id: 'strength', label: 'åŠ›é‡' },
  { id: 'agility', label: 'æ•æ·' }, { id: 'reflex', label: 'ååº”' },
  { id: 'iq', label: 'æ™ºå•†' }, { id: 'eq', label: 'æƒ…å•†' },
  { id: 'patience', label: 'è€å¿ƒ' }, { id: 'intuition', label: 'ç›´è§‰' },
  { id: 'luck', label: 'è¿æ°”' }, { id: 'drive', label: 'åŠ¨åŠ›' }
];

const personalityList = [
  { left: 'æ‚²è§‚', right: 'ä¹è§‚', id: 'p1' },
  { left: 'è‡ªå‘', right: 'è‡ªä¿¡', id: 'p2' },
  { left: 'å†·è¡€', right: 'æ¸©æŸ”', id: 'p3' },
  { left: 'å¼ºåŠ¿', right: 'å¼±åŠ¿', id: 'p4' },
  { left: 'é‡è›®', right: 'ç¤¼è²Œ', id: 'p5' },
  { left: 'å¹½é»˜', right: 'æ­£ç»', id: 'p6' },
  { left: 'å›é€†', right: 'ä¿å®ˆ', id: 'p7' },
  { left: 'åæ¿€', right: 'æ¸©é¡º', id: 'p8' },
  { left: 'é«˜å†·', right: 'çƒ­æƒ…', id: 'p9' },
  { left: 'æœå†³', right: 'çŠ¹è±«', id: 'p10' },
  { left: 'ç°å®', right: 'æµªæ¼«', id: 'p11' },
  { left: 'é‚ªæ¶', right: 'æ­£ä¹‰', id: 'p12' },
  { left: 'æ··æ²Œ', right: 'æ¸…é†’', id: 'p13' }
];

// ===== STATE =====
let state = {
  step: 1,
  stats: {},
  personality: {},
  selections: {},
  api: {
    enabled: true,
    verified: false,
    url: "https://api.deepseek.com",
    key: "sk-a6158402691b45cf82f26fa841f2cd27",
    model: "deepseek-chat"
  }
};

// ===== STEP 1 RENDERING =====
function renderStep1() {
  const attrContainer = document.getElementById('attributes-container');
  attrContainer.innerHTML = '';
  attributesList.forEach(t => {
    const row = document.createElement('div');
    row.className = "flex justify-between items-center";
    row.innerHTML = `
      <span class="text-xs font-medium text-slate-600 w-8">${t.label}</span>
      <div class="dot-group" id="dots-${t.id}">
        ${[1,2,3,4,5].map(i => `<div class="dot" onclick="setStat('${t.id}', ${i})"></div>`).join('')}
      </div>
    `;
    attrContainer.appendChild(row);
    if(!state.stats[t.id]) state.stats[t.id] = 3;
  });
  updateDotVisuals();

  const persContainer = document.getElementById('personality-container');
  persContainer.innerHTML = '';
  personalityList.forEach(p => {
    const row = document.createElement('div');
    row.className = "flex items-center gap-2 text-xs";
    row.innerHTML = `
      <span class="w-8 text-right text-slate-400">${p.left}</span>
      <input type="range" min="1" max="5" value="3" class="spectrum-slider flex-1" 
             oninput="setPersonality('${p.id}', this.value)" id="range-${p.id}">
      <span class="w-8 text-left text-slate-400">${p.right}</span>
    `;
    persContainer.appendChild(row);
    state.personality[p.id] = 3;
  });
}

function setStat(id, val) {
  state.stats[id] = val;
  updateDotVisuals();
  updatePreview();
}

function updateDotVisuals() {
  attributesList.forEach(t => {
    const val = state.stats[t.id];
    const container = document.getElementById(`dots-${t.id}`);
    if(!container) return;
    Array.from(container.children).forEach((dot, idx) => {
      if (idx < val) dot.classList.add('active');
      else dot.classList.remove('active');
    });
  });
}

function setPersonality(id, val) {
  state.personality[id] = parseInt(val);
  updatePreview();
}

function randomizeSheet() {
  attributesList.forEach(t => setStat(t.id, Math.floor(Math.random()*5)+1));
  personalityList.forEach(p => {
    const val = Math.floor(Math.random()*5)+1;
    const el = document.getElementById(`range-${p.id}`);
    if(el) el.value = val;
    setPersonality(p.id, val);
  });
  
  const genders = ["ç”·", "å¥³", "æ— æ€§"];
  document.getElementById('input-gender').value = genders[Math.floor(Math.random()*3)];
  document.getElementById('input-age').value = Math.floor(Math.random()*40)+15;
  
  const heightEl = document.getElementById('input-height');
  if(heightEl) {
    heightEl.value = Math.floor(Math.random()*50)+150;
  }
  
  if(state.api.verified) {
    const nameEl = document.getElementById('input-name');
    if(nameEl) generateSingleField('name');
    generateSingleField('race');
    generateSingleField('archetype');
  }
  updatePreview();
}

// ===== AI INTERACTION (Only for contextual generation) =====
async function generateSingleField(field) {
  const btn = event?.currentTarget;
  if(btn) btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i>';
  
  try {
    const profile = getProfileSummary();
    let prompt = '';
    
    if(field === 'name') {
      prompt = `åŸºäºè§’è‰²è®¾å®šç”Ÿæˆ1ä¸ªåˆé€‚çš„ä¸­æ–‡å§“å(2-4å­—):${profile}ã€‚åªè¾“å‡ºJSONæ•°ç»„æ ¼å¼:["å§“å"]`;
    } else if(field === 'race') {
      prompt = `åŸºäºè§’è‰²è®¾å®šç”Ÿæˆ1ä¸ªåˆ›æ„ç§æ—åç§°(ä¸­æ–‡,2-4å­—):${profile}ã€‚åªè¾“å‡ºJSONæ•°ç»„æ ¼å¼:["ç§æ—"]`;
    } else {
      prompt = `åŸºäºè§’è‰²è®¾å®šç”Ÿæˆ1ä¸ªåˆ›æ„èŒä¸š/èº«ä»½(ä¸­æ–‡,6-10å­—):${profile}ã€‚åªè¾“å‡ºJSONæ•°ç»„æ ¼å¼:["èŒä¸š"]`;
    }
    
    const res = await callAI(prompt, 1);
    const targetId = field === 'name' ? 'input-name' : `input-${field}`;
    const element = document.getElementById(targetId);
    if(element) {
      element.value = res[0] || "";
      updatePreview();
    }
  } catch(e) {
    console.error(e);
  }
  if(btn) btn.innerHTML = '<i class="fa-solid fa-magic"></i>';
}

async function callAI(userPrompt, count = 8) {
  if(!state.api.verified && !state.api.key) {
    return ["éœ€è¿æ¥AI"];
  }
  
  const fullUrl = `${state.api.url}/chat/completions`;
  try {
    const res = await fetch(fullUrl, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${state.api.key}`
      },
      body: JSON.stringify({
        model: state.api.model,
        messages: [{
          role: "system",
          content: `ä½ æ˜¯è§’è‰²ç”ŸæˆåŠ©æ‰‹ã€‚ä¸¥æ ¼æŒ‰è¦æ±‚è¾“å‡ºJSONæ•°ç»„æ ¼å¼:["é€‰é¡¹1","é€‰é¡¹2",...],å…±${count}ä¸ªä¸­æ–‡çŸ­è¯ã€‚`
        }, {
          role: "user",
          content: userPrompt
        }],
        temperature: 0.9
      })
    });
    
    if(!res.ok) throw new Error(`HTTP ${res.status}`);
    const data = await res.json();
    let txt = data.choices[0].message.content;
    txt = txt.replace(/```json|```/g, '').trim();
    return JSON.parse(txt);
  } catch(e) {
    console.error("AI Error", e);
    return ["Error", "Check API"];
  }
}

function getProfileSummary() {
  let text = `æ€§åˆ«:${document.getElementById('input-gender').value}, å¹´é¾„:${document.getElementById('input-age').value}, ç§æ—:${document.getElementById('input-race').value}, èŒä¸š:${document.getElementById('input-archetype').value}. `;
  text += "å±æ€§: ";
  attributesList.forEach(t => text += `${t.label}=${state.stats[t.id]}/5, `);
  text += "æ€§æ ¼: ";
  personalityList.forEach(p => {
    const val = state.personality[p.id];
    if(val < 3) text += `${p.left}, `;
    if(val > 3) text += `${p.right}, `;
  });
  return text;
}

// ===== STEP 2: VISUALS (Multi-select) =====
async function renderSection(containerId, category) {
  const container = document.getElementById(containerId);
  
  if(!container) {
    console.error("Container not found:", containerId);
    return;
  }
  
  // Use local presets if available
  let options = LOCAL_PRESETS[category];
  
  // Use AI for contextual categories
  if (!options) {
    container.innerHTML = '<div class="text-xs text-slate-400 p-2"><i class="fa-solid fa-spinner fa-spin"></i> AI æ¨æ¼”ä¸­...</div>';
    options = await fetchAIOptions(category);
  }
  
  // Initialize array if not exists (for multi-select)
  if(!state.selections[category]) {
    state.selections[category] = [];
  }
  
  container.innerHTML = '';
  
  if(!options || options.length === 0) {
    container.innerHTML = '<div class="text-xs text-red-400 p-2">åŠ è½½å¤±è´¥</div>';
    return;
  }
  
  // Determine if this category supports multi-select
  const multiSelectCategories = [
    'hair-length', 'hair-style', 'hair-color',
    'eye-shape', 'eye-color', 'special-marks', 'accessories',
    'facial-features', 'clothing-style', 'clothing-item',
    'phobias', 'mental_trauma', 'favorite_things', 'hated_things',
    'social_reputation', 'inventory_items'
  ];
  const isMultiSelect = multiSelectCategories.includes(category);
  
  options.forEach(opt => {
    const btn = document.createElement('button');
    btn.className = 'option-btn px-2 py-1.5 bg-white border border-slate-200 rounded text-xs text-slate-600 hover:border-slate-400 text-left';
    btn.textContent = opt;
    
    // Check if already selected
    if(Array.isArray(state.selections[category]) && state.selections[category].includes(opt)) {
      btn.classList.add('selected');
    } else if(state.selections[category] === opt) {
      btn.classList.add('selected');
    }
    
    btn.onclick = () => {
      if(isMultiSelect) {
        // Multi-select mode
        if(!Array.isArray(state.selections[category])) {
          state.selections[category] = [];
        }
        
        if(state.selections[category].includes(opt)) {
          // Remove
          state.selections[category] = state.selections[category].filter(x => x !== opt);
          btn.classList.remove('selected');
        } else {
          // Add
          state.selections[category].push(opt);
          btn.classList.add('selected');
        }
      } else {
        // Single-select mode
        Array.from(container.children).forEach(c => c.classList.remove('selected'));
        btn.classList.add('selected');
        state.selections[category] = opt;
      }
      updatePreview();
    };
    container.appendChild(btn);
  });
}

async function fetchAIOptions(category) {
  const profile = getProfileSummary();
  
  const prompts = {
    'facial-features': `åŸºäº${profile},ç”Ÿæˆ8ä¸ªé¢éƒ¨ç‰¹å¾æè¿°(å¦‚:é«˜é¼»æ¢ã€é›€æ–‘ã€é…’çªç­‰)`,
    'clothing-style': `åŸºäº${profile},ç”Ÿæˆ8ä¸ªç©¿æ­é£æ ¼(å¦‚:æœ‹å…‹ã€å­¦é™¢é£ã€å†›è£…ç­‰)`,
    'clothing-item': `åŸºäº${profile},ç”Ÿæˆ8ä¸ªæ ‡å¿—æ€§æœé¥°å•å“(å¦‚:çš®å¤¹å…‹ã€å›´å·¾ã€å¢¨é•œç­‰)`,
    'phobias': `åŸºäº${profile},æ¨æµ‹8ä¸ªå¯èƒ½çš„ææƒ§å¯¹è±¡`,
    'mental_trauma': `åŸºäº${profile},æ¨æµ‹8ä¸ªå¯èƒ½çš„å¿ƒç†åˆ›ä¼¤`,
    'favorite_things': `åŸºäº${profile},æ¨æµ‹8ä¸ªå–œçˆ±çš„äº‹ç‰©`,
    'hated_things': `åŸºäº${profile},æ¨æµ‹8ä¸ªåŒæ¶çš„äº‹ç‰©`,
    'social_reputation': `åŸºäº${profile},ç”Ÿæˆ8ä¸ªç¤¾ä¼šè¯„ä»·æ ‡ç­¾`,
    'inventory_items': `åŸºäº${profile},ç”Ÿæˆ8ä¸ªé‡è¦éšèº«ç‰©å“`
  };
  
  const prompt = prompts[category] || `ç”Ÿæˆ8ä¸ªå…³äº${category}çš„ä¸­æ–‡çŸ­è¯`;
  return await callAI(prompt, 8);
}

async function finishStep1() {
  goToStep(2);
  // Load local presets immediately
  renderSection('opt-hair-length', 'hair-length');
  renderSection('opt-hair-style', 'hair-style');
  renderSection('opt-hair-color', 'hair-color');
  renderSection('opt-eye-shape', 'eye-shape');
  renderSection('opt-eye-color', 'eye-color');
  renderSection('opt-body-build', 'body-build');
  renderSection('opt-skin-tone', 'skin-tone');
  renderSection('opt-face-structure', 'facial-structure');
  renderSection('opt-special-marks', 'special-marks');
  renderSection('opt-accessories', 'accessories');
  
  // Load AI-based options
  renderSection('opt-face-feature', 'facial-features');
  renderSection('opt-cloth-style', 'clothing-style');
  renderSection('opt-cloth-item', 'clothing-item');
}

async function finishStep2() {
  goToStep(3);
  document.getElementById('summary-archetype').textContent = document.getElementById('input-archetype').value;
  
  // All Step 3 options use AI
  renderSection('opt-fear', 'phobias');
  renderSection('opt-trauma', 'mental_trauma');
  renderSection('opt-likes', 'favorite_things');
  renderSection('opt-dislikes', 'hated_things');
  renderSection('opt-social', 'social_reputation');
  renderSection('opt-items', 'inventory_items');
}

async function finishStep3() {
  goToStep(4);
  await generateDeepDetails();
}

async function finishStep4() {
  goToStep(5);
}

async function refreshVisuals(group) {
  if(group === 'hair') {
    renderSection('opt-hair-length', 'hair-length');
    renderSection('opt-hair-style', 'hair-style');
    renderSection('opt-hair-color', 'hair-color');
  }
}

function goToStep(n) {
  state.step = n;
  document.querySelectorAll('.step-panel').forEach(p => p.classList.remove('active'));
  document.getElementById(`step-${n}`).classList.add('active');
  
  // Update step indicators
  for(let i = 1; i <= 5; i++) {
    const dot = document.getElementById(`step-dot-${i}`);
    if(dot) {
      if(i === n) dot.className = 'text-slate-800 font-bold';
      else if(i < n) dot.className = 'text-slate-500';
      else dot.className = 'text-slate-400';
    }
  }
  
  // Scroll to top
  const mainScroll = document.getElementById('main-scroll');
  if(mainScroll) mainScroll.scrollTop = 0;
  
  updatePreview();
}

// ===== PREVIEW UPDATE =====
function updatePreview() {
  const nameEl = document.getElementById('input-name');
  if(nameEl) {
    document.getElementById('p-name').textContent = nameEl.value || 'æœªå‘½å';
  }
  
  document.getElementById('p-archetype').textContent = document.getElementById('input-archetype').value || '???';
  document.getElementById('p-gender').textContent = document.getElementById('input-gender').value;
  document.getElementById('p-race').textContent = 'ç§æ—: ' + (document.getElementById('input-race').value || '?');
  document.getElementById('p-age').textContent = 'Age: ' + document.getElementById('input-age').value;
  
  const heightEl = document.getElementById('input-height');
  if(heightEl && heightEl.value) {
    document.getElementById('p-height').textContent = 'H: ' + heightEl.value + 'cm';
  }
  
  document.getElementById('p-alignment').textContent = 'é˜µè¥: ' + document.getElementById('input-alignment').value;

  const sDiv = document.getElementById('p-stats');
  sDiv.innerHTML = '';
  attributesList.forEach(t => {
    const v = state.stats[t.id];
    if(v > 3 || v < 2) {
      const d = document.createElement('span');
      d.className = "text-[10px] bg-slate-100 px-1 rounded text-slate-600";
      d.textContent = `${t.label}:${v}`;
      sDiv.appendChild(d);
    }
  });

  const pDiv = document.getElementById('p-personality');
  pDiv.innerHTML = '';
  personalityList.forEach(p => {
    const v = state.personality[p.id];
    if(v !== 3) {
      const d = document.createElement('span');
      d.className = "text-[10px] text-slate-500 mr-2";
      d.textContent = v < 3 ? p.left : p.right;
      pDiv.appendChild(d);
    }
  });

  const vList = document.getElementById('p-visuals');
  vList.innerHTML = '';
  const s = state.selections;
  const add = (txt) => { if(txt) vList.innerHTML += `<li>${txt}</li>`; };
  
  // Helper to get selected items (handles both array and string)
  const getSelected = (key) => {
    if(!s[key]) return '';
    if(Array.isArray(s[key])) return s[key].join(', ');
    return s[key];
  };
  
  if(getSelected('hair-length') || getSelected('hair-color')) {
    add(`å‘: ${getSelected('hair-length')} ${getSelected('hair-style')} (${getSelected('hair-color')})`);
  }
  if(getSelected('eye-color')) add(`çœ¼: ${getSelected('eye-color')} ${getSelected('eye-shape')}`);
  if(getSelected('skin-tone')) add(`è‚¤: ${getSelected('skin-tone')}`);
  if(getSelected('facial-structure')) add(`è„¸: ${getSelected('facial-structure')}`);
  if(getSelected('special-marks')) add(`æ ‡è®°: ${getSelected('special-marks')}`);
  if(getSelected('facial-features')) add(`é¢: ${getSelected('facial-features')}`);
  if(getSelected('body-build')) add(`ä½“: ${getSelected('body-build')}`);
  if(getSelected('accessories')) add(`é…é¥°: ${getSelected('accessories')}`);
  if(getSelected('clothing-style')) add(`è¡£: ${getSelected('clothing-style')} - ${getSelected('clothing-item')}`);

  const soulDiv = document.getElementById('p-soul');
  soulDiv.innerHTML = '';
  ['phobias','mental_trauma','favorite_things','hated_things','social_reputation','inventory_items'].forEach(k => {
    const items = s[k];
    if(items) {
      const itemArray = Array.isArray(items) ? items : [items];
      itemArray.forEach(item => {
        const tag = document.createElement('span');
        tag.className = "bg-slate-800 text-white px-1.5 py-0.5 rounded text-[10px]";
        tag.textContent = item;
        soulDiv.appendChild(tag);
      });
    }
  });
}

function copyResult() {
  const t = document.getElementById('preview-card').innerText;
  navigator.clipboard.writeText(t).then(() => alert("å·²å¤åˆ¶åˆ°å‰ªè´´æ¿"));
}

// ===== STEP 4: DEEP DETAILS (Interactive Q&A) =====
let currentQuestions = [];
let currentQuestionIndex = 0;
let questionAnswers = {};

async function generateDeepDetails() {
  const container = document.getElementById('deep-details-container');
  container.innerHTML = '<div class="text-center py-8"><i class="fa-solid fa-spinner fa-spin text-3xl text-purple-500"></i><p class="text-sm text-slate-500 mt-3">AI æ­£åœ¨å‡†å¤‡é—®é¢˜...</p></div>';
  
  currentQuestions = [];
  currentQuestionIndex = 0;
  questionAnswers = {};
  
  const s = state.selections;
  
  // Helper to get selected items
  const getSelected = (key) => {
    if(!s[key]) return [];
    return Array.isArray(s[key]) ? s[key] : [s[key]];
  };
  
  // Generate questions based on selections
  const marks = getSelected('special-marks');
  if(marks.some(m => ['ç–¤ç—•', 'åˆ€ç–¤', 'çƒ§ä¼¤ç—•è¿¹', 'å¼¹å­”ç–¤'].includes(m))) {
    currentQuestions.push({
      id: 'scars',
      category: 'ä¼¤ç–¤ç»†èŠ‚',
      question: `ä½ é€‰æ‹©äº†ä»¥ä¸‹æ ‡è®°ï¼š${marks.join('ã€')}ã€‚è¯·æè¿°è¿™äº›ä¼¤ç–¤çš„å…·ä½“ä½ç½®ã€å½¢çŠ¶ã€å¤§å°ï¼Œä»¥åŠå®ƒä»¬çš„æ¥å†ã€‚`,
      context: `è§’è‰²æœ‰: ${marks.join(', ')}`
    });
  }
  
  const trauma = getSelected('mental_trauma');
  if(trauma.length > 0) {
    currentQuestions.push({
      id: 'trauma',
      category: 'åˆ›ä¼¤æ¥æº',
      question: `ä½ é€‰æ‹©äº†ä»¥ä¸‹å¿ƒç†åˆ›ä¼¤ï¼š${trauma.join('ã€')}ã€‚è¯·æè¿°è¿™äº›åˆ›ä¼¤æ˜¯å¦‚ä½•å½¢æˆçš„ï¼Ÿå‘ç”Ÿäº†ä»€ä¹ˆäº‹ä»¶ï¼Ÿ`,
      context: `è§’è‰²æœ‰å¿ƒç†åˆ›ä¼¤: ${trauma.join(', ')}`
    });
  }
  
  const items = getSelected('inventory_items');
  if(items.length > 0) {
    currentQuestions.push({
      id: 'items',
      category: 'ç‰©å“æ•…äº‹',
      question: `ä½ é€‰æ‹©äº†ä»¥ä¸‹éšèº«ç‰©å“ï¼š${items.join('ã€')}ã€‚è¯·ä¸ºå…¶ä¸­æœ€é‡è¦çš„2-3ä»¶ç‰©å“è®²è¿°å®ƒä»¬çš„æ¥å†å’Œæ„ä¹‰ã€‚`,
      context: `è§’è‰²æºå¸¦: ${items.join(', ')}`
    });
  }
  
  const phobias = getSelected('phobias');
  if(phobias.length > 0) {
    currentQuestions.push({
      id: 'phobias',
      category: 'ææƒ§æ ¹æº',
      question: `ä½ é€‰æ‹©äº†ä»¥ä¸‹ææƒ§å¯¹è±¡ï¼š${phobias.join('ã€')}ã€‚è¿™äº›ææƒ§æ˜¯å¦‚ä½•äº§ç”Ÿçš„ï¼Ÿæœ‰ä»€ä¹ˆå…·ä½“çš„è§¦å‘åœºæ™¯å—ï¼Ÿ`,
      context: `è§’è‰²ææƒ§: ${phobias.join(', ')}`
    });
  }
  
  const clothStyle = getSelected('clothing-style');
  const clothItem = getSelected('clothing-item');
  if(clothStyle.length > 0 || clothItem.length > 0) {
    currentQuestions.push({
      id: 'clothing',
      category: 'ç©¿æ­ç»†èŠ‚',
      question: `ä½ é€‰æ‹©äº†ç©¿æ­é£æ ¼ï¼š${clothStyle.join('ã€')}ï¼Œæ ‡å¿—å•å“ï¼š${clothItem.join('ã€')}ã€‚è¯·æè¿°ä¸€å¥—å®Œæ•´çš„æ—¥å¸¸ç©¿æ­ï¼ŒåŒ…æ‹¬é¢œè‰²ã€æè´¨ã€æ­é…æ–¹å¼ã€‚`,
      context: `ç©¿æ­é£æ ¼: ${clothStyle.join(', ')}ï¼Œå•å“: ${clothItem.join(', ')}`
    });
  }
  
  const personalityTraits = [];
  personalityList.forEach(p => {
    const v = state.personality[p.id];
    if(v < 2) personalityTraits.push(p.left);
    if(v > 4) personalityTraits.push(p.right);
  });
  
  if(personalityTraits.length > 0) {
    currentQuestions.push({
      id: 'personality',
      category: 'æ€§æ ¼è¡¨ç°',
      question: `è§’è‰²çš„æ€§æ ¼ç‰¹å¾åŒ…æ‹¬ï¼š${personalityTraits.join('ã€')}ã€‚è¯·ä¸¾2-3ä¸ªå…·ä½“çš„æ—¥å¸¸åœºæ™¯ä¾‹å­ï¼Œå±•ç°è¿™äº›æ€§æ ¼æ˜¯å¦‚ä½•è¡¨ç°å‡ºæ¥çš„ã€‚`,
      context: `æ€§æ ¼ç‰¹å¾: ${personalityTraits.join(', ')}`
    });
  }
  
  container.innerHTML = '';
  
  if(currentQuestions.length === 0) {
    container.innerHTML = '<div class="text-center py-8 text-slate-400"><i class="fa-solid fa-info-circle text-2xl mb-2"></i><p class="text-sm">æš‚æ— éœ€è¦æ·±åº¦ç»†åŒ–çš„å†…å®¹</p><p class="text-xs mt-2">æç¤ºï¼šé€‰æ‹©ç–¤ç—•ã€åˆ›ä¼¤ç­‰ç‰¹å¾åä¼šæœ‰æ›´å¤šé—®é¢˜</p></div>';
    return;
  }
  
  // Show first question
  await showQuestion(0);
}

async function showQuestion(index) {
  if(index >= currentQuestions.length) {
    // All questions answered
    showCompletionSummary();
    return;
  }
  
  currentQuestionIndex = index;
  const q = currentQuestions[index];
  const container = document.getElementById('deep-details-container');
  
  // Step 1: AI asks question, user provides their answer
  container.innerHTML = `
    <div class="bg-white p-6 rounded-xl shadow-sm border-2 border-purple-300">
      <div class="flex justify-between items-start mb-4">
        <div>
          <h4 class="text-lg font-bold text-purple-900 mb-1">æ­¥éª¤ 1/5: ${q.category}</h4>
          <p class="text-xs text-slate-500">é—®é¢˜ ${index + 1} / ${currentQuestions.length}</p>
        </div>
        <div class="text-xs bg-purple-100 text-purple-700 px-3 py-1 rounded-full">
          ${index + 1}/${currentQuestions.length}
        </div>
      </div>
      
      <div class="bg-purple-50 p-4 rounded-lg mb-4">
        <div class="flex items-start gap-2">
          <i class="fa-solid fa-robot text-purple-600 text-xl mt-1"></i>
          <div>
            <p class="text-xs font-bold text-purple-700 mb-1">AI çš„é—®é¢˜ï¼š</p>
            <p class="text-sm text-slate-700 leading-relaxed">${q.question}</p>
          </div>
        </div>
      </div>
      
      <div class="mb-4">
        <label class="text-xs font-bold text-slate-600 uppercase block mb-2">
          <i class="fa-solid fa-user"></i> ä½ çš„å›ç­”
        </label>
        <textarea id="user-initial-answer" class="w-full p-3 border-2 border-purple-300 rounded-lg text-sm resize-none focus:border-purple-500 focus:ring-2 focus:ring-purple-200" rows="4" placeholder="è¯·ç®€è¦å›ç­”è¿™ä¸ªé—®é¢˜ï¼ŒAI ä¼šæ ¹æ®ä½ çš„å›ç­”ç”Ÿæˆè¯¦ç»†å†…å®¹..."></textarea>
        <p class="text-xs text-slate-500 mt-1">ğŸ’¡ æç¤ºï¼šç®€å•æè¿°å³å¯ï¼ŒAI ä¼šå¸®ä½ æ‰©å±•æˆå®Œæ•´å†…å®¹</p>
      </div>
      
      <div class="flex justify-between items-center pt-4 border-t">
        <button onclick="skipQuestion()" class="text-slate-400 hover:text-slate-600 px-4 py-2 text-sm">
          <i class="fa-solid fa-forward"></i> è·³è¿‡æ­¤é—®é¢˜
        </button>
        <button onclick="submitUserAnswer()" class="bg-purple-600 hover:bg-purple-700 text-white px-6 py-2 rounded-lg text-sm font-medium transition flex items-center gap-2">
          <i class="fa-solid fa-paper-plane"></i> æäº¤å›ç­”ï¼Œè®© AI ç”Ÿæˆè¯¦ç»†å†…å®¹
        </button>
      </div>
    </div>
    
    ${index > 0 ? `
    <div class="mt-4">
      <button onclick="showQuestion(${index - 1})" class="text-sm text-slate-500 hover:text-slate-700">
        <i class="fa-solid fa-arrow-left"></i> è¿”å›ä¸Šä¸€ä¸ªé—®é¢˜
      </button>
    </div>
    ` : ''}
  `;
}

// Step 2: User submits their answer, AI generates detailed content
async function submitUserAnswer() {
  const userAnswer = document.getElementById('user-initial-answer').value.trim();
  if(!userAnswer) {
    alert('è¯·å…ˆå›ç­”é—®é¢˜');
    return;
  }
  
  const q = currentQuestions[currentQuestionIndex];
  const container = document.getElementById('deep-details-container');
  
  // Show loading state
  container.innerHTML = `
    <div class="bg-white p-6 rounded-xl shadow-sm border-2 border-purple-300">
      <div class="flex justify-between items-start mb-4">
        <div>
          <h4 class="text-lg font-bold text-purple-900 mb-1">æ­¥éª¤ 2/5: AI ç”Ÿæˆè¯¦ç»†å†…å®¹</h4>
          <p class="text-xs text-slate-500">é—®é¢˜ ${currentQuestionIndex + 1} / ${currentQuestions.length}</p>
        </div>
      </div>
      
      <div class="bg-blue-50 p-4 rounded-lg mb-4">
        <div class="flex items-start gap-2">
          <i class="fa-solid fa-user text-blue-600 text-xl mt-1"></i>
          <div>
            <p class="text-xs font-bold text-blue-700 mb-1">ä½ çš„å›ç­”ï¼š</p>
            <p class="text-sm text-slate-700 leading-relaxed">${userAnswer}</p>
          </div>
        </div>
      </div>
      
      <div class="bg-slate-50 p-6 rounded-lg border border-slate-200 text-center">
        <i class="fa-solid fa-spinner fa-spin text-3xl text-purple-600 mb-3"></i>
        <p class="text-sm text-slate-600">AI æ­£åœ¨æ ¹æ®ä½ çš„å›ç­”ç”Ÿæˆè¯¦ç»†å†…å®¹...</p>
      </div>
    </div>
  `;
  
  try {
    const fullProfile = getFullProfile();
    const prompt = `${fullProfile}\n\n${q.context}\n\né—®é¢˜ï¼š${q.question}\n\nç”¨æˆ·çš„å›ç­”ï¼š${userAnswer}\n\nè¯·æ ¹æ®ç”¨æˆ·çš„å›ç­”ï¼Œç”¨ç¬¬ä¸‰äººç§°ï¼Œç”Ÿæˆä¸€æ®µ150-200å­—çš„è¯¦ç»†æè¿°ã€‚è¦ç¬¦åˆè§’è‰²è®¾å®šï¼Œå†…å®¹ä¸°å¯Œï¼Œæœ‰ç”»é¢æ„Ÿã€‚`;
    
    const aiGenerated = await callAIText(prompt);
    
    // Step 3: Show AI generated content and ask for approval
    showAIGeneratedContent(userAnswer, aiGenerated);
    
  } catch(e) {
    alert('AI ç”Ÿæˆå¤±è´¥ï¼š' + e.message);
    showQuestion(currentQuestionIndex); // Go back to question
  }
}

// Step 3: Show AI generated content and ask for user approval
function showAIGeneratedContent(userAnswer, aiGenerated) {
  const q = currentQuestions[currentQuestionIndex];
  const container = document.getElementById('deep-details-container');
  
  container.innerHTML = `
    <div class="bg-white p-6 rounded-xl shadow-sm border-2 border-purple-300">
      <div class="flex justify-between items-start mb-4">
        <div>
          <h4 class="text-lg font-bold text-purple-900 mb-1">æ­¥éª¤ 3/5: æŸ¥çœ‹ AI ç”Ÿæˆçš„å†…å®¹</h4>
          <p class="text-xs text-slate-500">é—®é¢˜ ${currentQuestionIndex + 1} / ${currentQuestions.length}</p>
        </div>
      </div>
      
      <div class="bg-blue-50 p-4 rounded-lg mb-3">
        <div class="flex items-start gap-2">
          <i class="fa-solid fa-user text-blue-600 text-lg mt-1"></i>
          <div class="flex-1">
            <p class="text-xs font-bold text-blue-700 mb-1">ä½ çš„å›ç­”ï¼š</p>
            <p class="text-sm text-slate-700 leading-relaxed">${userAnswer}</p>
          </div>
        </div>
      </div>
      
      <div class="bg-green-50 p-4 rounded-lg mb-4 border-2 border-green-200">
        <div class="flex items-start gap-2">
          <i class="fa-solid fa-robot text-green-600 text-lg mt-1"></i>
          <div class="flex-1">
            <p class="text-xs font-bold text-green-700 mb-1">AI ç”Ÿæˆçš„è¯¦ç»†å†…å®¹ï¼š</p>
            <p class="text-sm text-slate-700 leading-relaxed whitespace-pre-wrap" id="ai-generated-content">${aiGenerated}</p>
          </div>
        </div>
      </div>
      
      <div class="bg-amber-50 p-4 rounded-lg mb-4 border border-amber-200">
        <p class="text-sm text-amber-800 font-medium mb-2">
          <i class="fa-solid fa-question-circle"></i> ä½ å¯¹è¿™ä¸ªå†…å®¹æ»¡æ„å—ï¼Ÿ
        </p>
        <div class="flex gap-3">
          <button onclick="approveContent()" class="flex-1 bg-green-600 hover:bg-green-700 text-white px-4 py-3 rounded-lg text-sm font-medium transition flex items-center justify-center gap-2">
            <i class="fa-solid fa-check-circle text-lg"></i>
            <span>æ»¡æ„ï¼Œé€šè¿‡</span>
          </button>
          <button onclick="showModifyOptions()" class="flex-1 bg-orange-600 hover:bg-orange-700 text-white px-4 py-3 rounded-lg text-sm font-medium transition flex items-center justify-center gap-2">
            <i class="fa-solid fa-edit text-lg"></i>
            <span>ä¸æ»¡æ„ï¼Œéœ€è¦ä¿®æ”¹</span>
          </button>
        </div>
      </div>
    </div>
  `;
  
  // Store current data
  window.currentUserAnswer = userAnswer;
  window.currentAIGenerated = aiGenerated;
}

// Step 4: User chooses how to modify
function showModifyOptions() {
  const q = currentQuestions[currentQuestionIndex];
  const container = document.getElementById('deep-details-container');
  
  container.innerHTML = `
    <div class="bg-white p-6 rounded-xl shadow-sm border-2 border-orange-300">
      <div class="flex justify-between items-start mb-4">
        <div>
          <h4 class="text-lg font-bold text-orange-900 mb-1">æ­¥éª¤ 4/5: é€‰æ‹©ä¿®æ”¹æ–¹å¼</h4>
          <p class="text-xs text-slate-500">é—®é¢˜ ${currentQuestionIndex + 1} / ${currentQuestions.length}</p>
        </div>
      </div>
      
      <div class="bg-slate-50 p-4 rounded-lg mb-4">
        <p class="text-xs font-bold text-slate-600 mb-2">å½“å‰ AI ç”Ÿæˆçš„å†…å®¹ï¼š</p>
        <p class="text-sm text-slate-700 leading-relaxed">${window.currentAIGenerated}</p>
      </div>
      
      <div class="space-y-3">
        <button onclick="chooseSmallEdit()" class="w-full bg-blue-600 hover:bg-blue-700 text-white p-4 rounded-lg text-left transition border-2 border-transparent hover:border-blue-800">
          <div class="flex items-start gap-3">
            <i class="fa-solid fa-pen text-2xl mt-1"></i>
            <div>
              <p class="font-bold mb-1">ğŸ“ å°æ”¹ï¼šç›´æ¥ä¿®æ”¹æ–‡æœ¬</p>
              <p class="text-sm opacity-90">é€‚åˆï¼šæ”¹å‡ ä¸ªå­—ã€è°ƒæ•´è¯­å¥ã€ä¿®æ­£ç»†èŠ‚</p>
            </div>
          </div>
        </button>
        
        <button onclick="chooseBigEdit()" class="w-full bg-purple-600 hover:bg-purple-700 text-white p-4 rounded-lg text-left transition border-2 border-transparent hover:border-purple-800">
          <div class="flex items-start gap-3">
            <i class="fa-solid fa-comments text-2xl mt-1"></i>
            <div>
              <p class="font-bold mb-1">ğŸ’¬ å¤§æ”¹ï¼šç»™ AI æå»ºè®®</p>
              <p class="text-sm opacity-90">é€‚åˆï¼šæ”¹å˜æ–¹å‘ã€å¢åŠ å†…å®¹ã€é‡æ–°æ„æ€</p>
            </div>
          </div>
        </button>
        
        <button onclick="showAIGeneratedContent('${window.currentUserAnswer.replace(/'/g, "\\'")}', '${window.currentAIGenerated.replace(/'/g, "\\'")}', '${window.currentAIGenerated.replace(/'/g, "\\'")})" class="w-full bg-slate-500 hover:bg-slate-600 text-white px-4 py-2 rounded-lg text-sm transition">
          <i class="fa-solid fa-arrow-left"></i> è¿”å›æŸ¥çœ‹å†…å®¹
        </button>
      </div>
    </div>
  `;
}

// Step 4a: Small edit - direct text editing
function chooseSmallEdit() {
  const q = currentQuestions[currentQuestionIndex];
  const container = document.getElementById('deep-details-container');
  
  container.innerHTML = `
    <div class="bg-white p-6 rounded-xl shadow-sm border-2 border-blue-300">
      <div class="flex justify-between items-start mb-4">
        <div>
          <h4 class="text-lg font-bold text-blue-900 mb-1">æ­¥éª¤ 5/5: ç›´æ¥ä¿®æ”¹æ–‡æœ¬</h4>
          <p class="text-xs text-slate-500">é—®é¢˜ ${currentQuestionIndex + 1} / ${currentQuestions.length}</p>
        </div>
      </div>
      
      <div class="mb-4">
        <label class="text-xs font-bold text-slate-600 uppercase block mb-2">
          <i class="fa-solid fa-edit"></i> ç¼–è¾‘å†…å®¹ï¼ˆç›´æ¥ä¿®æ”¹ä¸‹é¢çš„æ–‡æœ¬ï¼‰
        </label>
        <textarea id="manual-edit-content" class="w-full p-3 border-2 border-blue-300 rounded-lg text-sm resize-none focus:border-blue-500 focus:ring-2 focus:ring-blue-200" rows="8">${window.currentAIGenerated}</textarea>
      </div>
      
      <div class="flex justify-between items-center pt-4 border-t">
        <button onclick="showModifyOptions()" class="text-slate-400 hover:text-slate-600 px-4 py-2 text-sm">
          <i class="fa-solid fa-arrow-left"></i> è¿”å›é€‰æ‹©ä¿®æ”¹æ–¹å¼
        </button>
        <button onclick="saveManualEdit()" class="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded-lg text-sm font-medium transition flex items-center gap-2">
          <i class="fa-solid fa-check"></i> ä¿å­˜å¹¶è¿›å…¥ä¸‹ä¸€é¢˜
        </button>
      </div>
    </div>
  `;
}

// Step 4b: Big edit - give AI suggestions
function chooseBigEdit() {
  const q = currentQuestions[currentQuestionIndex];
  const container = document.getElementById('deep-details-container');
  
  container.innerHTML = `
    <div class="bg-white p-6 rounded-xl shadow-sm border-2 border-purple-300">
      <div class="flex justify-between items-start mb-4">
        <div>
          <h4 class="text-lg font-bold text-purple-900 mb-1">æ­¥éª¤ 5/5: ç»™ AI æå»ºè®®</h4>
          <p class="text-xs text-slate-500">é—®é¢˜ ${currentQuestionIndex + 1} / ${currentQuestions.length}</p>
        </div>
      </div>
      
      <div class="bg-slate-50 p-4 rounded-lg mb-4">
        <p class="text-xs font-bold text-slate-600 mb-2">å½“å‰å†…å®¹ï¼š</p>
        <p class="text-sm text-slate-700 leading-relaxed">${window.currentAIGenerated}</p>
      </div>
      
      <div class="mb-4">
        <label class="text-xs font-bold text-slate-600 uppercase block mb-2">
          <i class="fa-solid fa-lightbulb"></i> ä½ çš„ä¿®æ”¹å»ºè®®
        </label>
        <textarea id="ai-suggestion-input" class="w-full p-3 border-2 border-purple-300 rounded-lg text-sm resize-none focus:border-purple-500 focus:ring-2 focus:ring-purple-200" rows="4" placeholder="ä¾‹å¦‚ï¼šå¢åŠ æ›´å¤šæƒ…æ„Ÿæå†™ã€æ”¹æˆæ‚²ä¼¤çš„è¯­æ°”ã€åŠ å…¥ç«¥å¹´å›å¿†çš„ç»†èŠ‚..."></textarea>
        <p class="text-xs text-slate-500 mt-1">ğŸ’¡ æç¤ºï¼šå‘Šè¯‰ AI ä½ æƒ³è¦ä»€ä¹ˆæ ·çš„æ”¹å˜ï¼ŒAI ä¼šé‡æ–°ç”Ÿæˆ</p>
      </div>
      
      <div class="flex justify-between items-center pt-4 border-t">
        <button onclick="showModifyOptions()" class="text-slate-400 hover:text-slate-600 px-4 py-2 text-sm">
          <i class="fa-solid fa-arrow-left"></i> è¿”å›é€‰æ‹©ä¿®æ”¹æ–¹å¼
        </button>
        <button onclick="regenerateWithSuggestion()" class="bg-purple-600 hover:bg-purple-700 text-white px-6 py-2 rounded-lg text-sm font-medium transition flex items-center gap-2">
          <i class="fa-solid fa-magic"></i> è®© AI é‡æ–°ç”Ÿæˆ
        </button>
      </div>
    </div>
  `;
}

// Save manual edit and move to next question
function saveManualEdit() {
  const editedContent = document.getElementById('manual-edit-content').value.trim();
  if(!editedContent) {
    alert('å†…å®¹ä¸èƒ½ä¸ºç©º');
    return;
  }
  
  const q = currentQuestions[currentQuestionIndex];
  questionAnswers[q.id] = {
    category: q.category,
    question: q.question,
    userAnswer: window.currentUserAnswer,
    answer: editedContent,
    source: 'manual-edit'
  };
  
  showQuestion(currentQuestionIndex + 1);
}

// Regenerate with user's suggestion
async function regenerateWithSuggestion() {
  const suggestion = document.getElementById('ai-suggestion-input').value.trim();
  if(!suggestion) {
    alert('è¯·è¾“å…¥ä½ çš„ä¿®æ”¹å»ºè®®');
    return;
  }
  
  const q = currentQuestions[currentQuestionIndex];
  const container = document.getElementById('deep-details-container');
  
  // Show loading
  container.innerHTML = `
    <div class="bg-white p-6 rounded-xl shadow-sm border-2 border-purple-300">
      <div class="bg-slate-50 p-6 rounded-lg border border-slate-200 text-center">
        <i class="fa-solid fa-spinner fa-spin text-3xl text-purple-600 mb-3"></i>
        <p class="text-sm text-slate-600">AI æ­£åœ¨æ ¹æ®ä½ çš„å»ºè®®é‡æ–°ç”Ÿæˆ...</p>
      </div>
    </div>
  `;
  
  try {
    const fullProfile = getFullProfile();
    const prompt = `${fullProfile}\n\n${q.context}\n\né—®é¢˜ï¼š${q.question}\n\nç”¨æˆ·çš„å›ç­”ï¼š${window.currentUserAnswer}\n\nä¹‹å‰ç”Ÿæˆçš„å†…å®¹ï¼š${window.currentAIGenerated}\n\nç”¨æˆ·çš„ä¿®æ”¹å»ºè®®ï¼š${suggestion}\n\nè¯·æ ¹æ®ç”¨æˆ·çš„ä¿®æ”¹å»ºè®®ï¼Œé‡æ–°ç”Ÿæˆä¸€æ®µ150-200å­—çš„è¯¦ç»†æè¿°ã€‚è¦ç¬¦åˆè§’è‰²è®¾å®šï¼Œå†…å®¹ä¸°å¯Œï¼Œæœ‰ç”»é¢æ„Ÿã€‚`;
    
    const newGenerated = await callAIText(prompt);
    
    // Show new content for approval
    showAIGeneratedContent(window.currentUserAnswer, newGenerated);
    
  } catch(e) {
    alert('AI ç”Ÿæˆå¤±è´¥ï¼š' + e.message);
    chooseBigEdit(); // Go back to suggestion input
  }
}

// Step 5: User approves the content
function approveContent() {
  const q = currentQuestions[currentQuestionIndex];
  questionAnswers[q.id] = {
    category: q.category,
    question: q.question,
    userAnswer: window.currentUserAnswer,
    answer: window.currentAIGenerated,
    source: 'approved'
  };
  
  showQuestion(currentQuestionIndex + 1);
}

function skipQuestion() {
  if(confirm('ç¡®å®šè¦è·³è¿‡è¿™ä¸ªé—®é¢˜å—ï¼Ÿ')) {
    showQuestion(currentQuestionIndex + 1);
  }
}

function showCompletionSummary() {
  const container = document.getElementById('deep-details-container');
  
  let summaryHTML = '<div class="space-y-4">';
  
  summaryHTML += `
    <div class="bg-green-100 p-6 rounded-xl border border-green-300 text-center">
      <i class="fa-solid fa-check-circle text-green-600 text-3xl mb-2"></i>
      <h3 class="text-lg font-bold text-green-900 mb-1">æ·±åº¦ç»†åŒ–å®Œæˆï¼</h3>
      <p class="text-sm text-green-700">å·²å›ç­” ${Object.keys(questionAnswers).length} ä¸ªé—®é¢˜</p>
    </div>
  `;
  
  // Show all answers
  Object.values(questionAnswers).forEach(qa => {
    const sourceLabel = {
      'approved': 'AI ç”Ÿæˆï¼ˆå·²é€šè¿‡ï¼‰',
      'manual-edit': 'æ‰‹åŠ¨ä¿®æ”¹',
      'user': 'å®Œå…¨è‡ªå®šä¹‰'
    }[qa.source] || 'AI ç”Ÿæˆ';
    
    const sourceColor = {
      'approved': 'bg-green-100 text-green-700',
      'manual-edit': 'bg-blue-100 text-blue-700',
      'user': 'bg-purple-100 text-purple-700'
    }[qa.source] || 'bg-green-100 text-green-700';
    
    summaryHTML += `
      <div class="bg-white p-5 rounded-xl shadow-sm border border-slate-200">
        <div class="flex justify-between items-start mb-3">
          <h4 class="text-sm font-bold text-slate-700">${qa.category}</h4>
          <span class="text-xs px-2 py-1 rounded ${sourceColor}">
            ${sourceLabel}
          </span>
        </div>
        <p class="text-xs text-slate-500 mb-2">${qa.question}</p>
        ${qa.userAnswer ? `
        <div class="bg-blue-50 p-3 rounded-lg mb-2">
          <p class="text-xs font-bold text-blue-700 mb-1">ä½ çš„å›ç­”ï¼š</p>
          <p class="text-sm text-slate-700 leading-relaxed">${qa.userAnswer}</p>
        </div>
        ` : ''}
        <div class="bg-slate-50 p-3 rounded-lg">
          <p class="text-xs font-bold text-slate-600 mb-1">æœ€ç»ˆå†…å®¹ï¼š</p>
          <p class="text-sm text-slate-700 leading-relaxed whitespace-pre-wrap">${qa.answer}</p>
        </div>
      </div>
    `;
  });
  
  summaryHTML += '</div>';
  
  container.innerHTML = summaryHTML;
}

async function callAIText(prompt) {
  const fullUrl = `${state.api.url}/chat/completions`;
  const res = await fetch(fullUrl, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'Authorization': `Bearer ${state.api.key}`
    },
    body: JSON.stringify({
      model: state.api.model,
      messages: [{role: "user", content: prompt}],
      temperature: 0.8
    })
  });
  
  if(!res.ok) throw new Error(`HTTP ${res.status}`);
  const data = await res.json();
  return data.choices[0].message.content.trim();
}

function getFullProfile() {
  const nameEl = document.getElementById('input-name');
  const heightEl = document.getElementById('input-height');
  
  let text = `ã€åŸºç¡€ä¿¡æ¯ã€‘\n`;
  text += `å§“å: ${nameEl ? nameEl.value : 'æœªå‘½å'}\n`;
  text += `æ€§åˆ«: ${document.getElementById('input-gender').value}\n`;
  text += `å¹´é¾„: ${document.getElementById('input-age').value}\n`;
  if(heightEl && heightEl.value) text += `èº«é«˜: ${heightEl.value}cm\n`;
  text += `ç§æ—: ${document.getElementById('input-race').value}\n`;
  text += `èŒä¸š: ${document.getElementById('input-archetype').value}\n`;
  text += `é˜µè¥: ${document.getElementById('input-alignment').value}\n\n`;
  
  text += `ã€å±æ€§ã€‘\n`;
  attributesList.forEach(t => {
    const v = state.stats[t.id];
    text += `${t.label}: ${v}/5, `;
  });
  
  text += `\n\nã€æ€§æ ¼ã€‘\n`;
  personalityList.forEach(p => {
    const v = state.personality[p.id];
    if(v !== 3) text += `${v < 3 ? p.left : p.right}, `;
  });
  
  text += `\n\nã€å¤–è²Œã€‘\n`;
  const s = state.selections;
  const getSelected = (key) => {
    if(!s[key]) return '';
    return Array.isArray(s[key]) ? s[key].join(', ') : s[key];
  };
  
  if(getSelected('hair-length')) text += `å¤´å‘é•¿åº¦: ${getSelected('hair-length')}\n`;
  if(getSelected('hair-style')) text += `å‘å‹: ${getSelected('hair-style')}\n`;
  if(getSelected('hair-color')) text += `å‘è‰²: ${getSelected('hair-color')}\n`;
  if(getSelected('eye-shape')) text += `çœ¼å‹: ${getSelected('eye-shape')}\n`;
  if(getSelected('eye-color')) text += `ç³è‰²: ${getSelected('eye-color')}\n`;
  if(getSelected('skin-tone')) text += `è‚¤è‰²: ${getSelected('skin-tone')}\n`;
  if(getSelected('facial-structure')) text += `è„¸å‹: ${getSelected('facial-structure')}\n`;
  if(getSelected('special-marks')) text += `ç‰¹æ®Šæ ‡è®°: ${getSelected('special-marks')}\n`;
  if(getSelected('body-build')) text += `ä½“å‹: ${getSelected('body-build')}\n`;
  if(getSelected('accessories')) text += `é…é¥°: ${getSelected('accessories')}\n`;
  if(getSelected('clothing-style')) text += `æœè£…é£æ ¼: ${getSelected('clothing-style')}\n`;
  
  text += `\nã€å¿ƒç†ç‰¹å¾ã€‘\n`;
  if(getSelected('phobias')) text += `ææƒ§: ${getSelected('phobias')}\n`;
  if(getSelected('mental_trauma')) text += `åˆ›ä¼¤: ${getSelected('mental_trauma')}\n`;
  if(getSelected('favorite_things')) text += `å–œå¥½: ${getSelected('favorite_things')}\n`;
  if(getSelected('hated_things')) text += `åŒæ¶: ${getSelected('hated_things')}\n`;
  if(getSelected('social_reputation')) text += `ç¤¾ä¼šè¯„ä»·: ${getSelected('social_reputation')}\n`;
  if(getSelected('inventory_items')) text += `éšèº«ç‰©å“: ${getSelected('inventory_items')}\n`;
  
  return text;
}

// ===== EXPORT / IMPORT =====
function exportCharacter() {
  const nameEl = document.getElementById('input-name');
  const heightEl = document.getElementById('input-height');
  
  const data = {
    version: "7.0",
    timestamp: new Date().toISOString(),
    basic: {
      name: nameEl ? nameEl.value : '',
      gender: document.getElementById('input-gender').value,
      age: document.getElementById('input-age').value,
      height: heightEl ? heightEl.value : '',
      race: document.getElementById('input-race').value,
      alignment: document.getElementById('input-alignment').value,
      archetype: document.getElementById('input-archetype').value
    },
    stats: state.stats,
    personality: state.personality,
    selections: state.selections,
    questionAnswers: questionAnswers  // Include Step 4 Q&A data
  };
  
  const json = JSON.stringify(data, null, 2);
  const blob = new Blob([json], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `character_${data.basic.archetype || 'unnamed'}_${Date.now()}.json`;
  a.click();
  URL.revokeObjectURL(url);
}

function importCharacter() {
  const input = document.createElement('input');
  input.type = 'file';
  input.accept = '.json';
  input.onchange = (e) => {
    const file = e.target.files[0];
    if (!file) return;
    
    const reader = new FileReader();
    reader.onload = (event) => {
      try {
        const data = JSON.parse(event.target.result);
        
        // Restore basic info
        const nameEl = document.getElementById('input-name');
        const heightEl = document.getElementById('input-height');
        
        if(nameEl) nameEl.value = data.basic.name || '';
        document.getElementById('input-gender').value = data.basic.gender || 'ç”·';
        document.getElementById('input-age').value = data.basic.age || 20;
        if(heightEl) heightEl.value = data.basic.height || '';
        document.getElementById('input-race').value = data.basic.race || '';
        document.getElementById('input-alignment').value = data.basic.alignment || 'ç»å¯¹ä¸­ç«‹';
        document.getElementById('input-archetype').value = data.basic.archetype || '';
        
        // Restore stats
        state.stats = data.stats || {};
        updateDotVisuals();
        
        // Restore personality
        state.personality = data.personality || {};
        personalityList.forEach(p => {
          const el = document.getElementById(`range-${p.id}`);
          if(el && state.personality[p.id]) {
            el.value = state.personality[p.id];
          }
        });
        
        // Restore selections
        state.selections = data.selections || {};
        
        // Restore Step 4 Q&A answers (if available)
        if(data.questionAnswers) {
          Object.keys(questionAnswers).forEach(key => delete questionAnswers[key]);
          Object.assign(questionAnswers, data.questionAnswers);
        }
        
        updatePreview();
        alert('è§’è‰²å¯¼å…¥æˆåŠŸï¼');
      } catch(e) {
        alert('å¯¼å…¥å¤±è´¥ï¼šæ–‡ä»¶æ ¼å¼é”™è¯¯');
        console.error(e);
      }
    };
    reader.readAsText(file);
  };
  input.click();
}

// ===== AI PROMPT GENERATION =====
async function generatePrompt() {
  const btn = event.currentTarget;
  const originalHTML = btn.innerHTML;
  btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> ç”Ÿæˆä¸­...';
  btn.disabled = true;
  
  try {
    const profile = getFullProfile();
    const prompt = `ä½ æ˜¯ä¸“ä¸šçš„ AI ç»˜å›¾ Prompt å·¥ç¨‹å¸ˆã€‚æ ¹æ®ä»¥ä¸‹è§’è‰²ä¿¡æ¯ï¼Œç”Ÿæˆä¸€ä¸ªè¯¦ç»†çš„è‹±æ–‡ Stable Diffusion / Midjourney é£æ ¼çš„ç»˜å›¾æç¤ºè¯ã€‚

è§’è‰²ä¿¡æ¯ï¼š
${profile}

è¦æ±‚ï¼š
1. ä½¿ç”¨è‹±æ–‡ï¼Œç”¨é€—å·åˆ†éš”çš„å…³é”®è¯æ ¼å¼
2. åŒ…å«ï¼šç”»é£ã€è§’è‰²å¤–è²Œã€æœè£…ã€è¡¨æƒ…ã€å§¿åŠ¿ã€èƒŒæ™¯ã€å…‰å½±ã€ç”»è´¨æ ‡ç­¾
3. çªå‡ºè§’è‰²çš„æ ¸å¿ƒç‰¹å¾å’Œä¸ªæ€§
4. é•¿åº¦æ§åˆ¶åœ¨ 150-200 è¯
5. åªè¾“å‡º prompt æœ¬èº«ï¼Œä¸è¦è§£é‡Š

ç¤ºä¾‹æ ¼å¼ï¼š
masterpiece, best quality, 1girl, [hair description], [eye description], [clothing], [expression], [pose], [background], detailed, high resolution`;

    const result = await callAI(prompt, 1);
    const generatedPrompt = result[0] || "ç”Ÿæˆå¤±è´¥";
    
    document.getElementById('prompt-content').textContent = generatedPrompt;
    document.getElementById('prompt-display').classList.remove('hidden');
    
    // Scroll to prompt
    document.getElementById('prompt-display').scrollIntoView({ behavior: 'smooth', block: 'nearest' });
  } catch(e) {
    alert('ç”Ÿæˆå¤±è´¥ï¼š' + e.message);
  }
  
  btn.innerHTML = originalHTML;
  btn.disabled = false;
}

function getFullProfile() {
  let text = `ã€åŸºç¡€ä¿¡æ¯ã€‘\n`;
  text += `æ€§åˆ«: ${document.getElementById('input-gender').value}\n`;
  text += `å¹´é¾„: ${document.getElementById('input-age').value}\n`;
  text += `ç§æ—: ${document.getElementById('input-race').value}\n`;
  text += `èŒä¸š: ${document.getElementById('input-archetype').value}\n`;
  text += `é˜µè¥: ${document.getElementById('input-alignment').value}\n\n`;
  
  text += `ã€å±æ€§ã€‘\n`;
  attributesList.forEach(t => {
    const v = state.stats[t.id];
    if(v > 3 || v < 2) text += `${t.label}: ${v}/5, `;
  });
  text += `\n\nã€æ€§æ ¼ã€‘\n`;
  personalityList.forEach(p => {
    const v = state.personality[p.id];
    if(v !== 3) text += `${v < 3 ? p.left : p.right}, `;
  });
  
  text += `\n\nã€å¤–è²Œã€‘\n`;
  const s = state.selections;
  if(s['hair-length']) text += `å¤´å‘: ${s['hair-length']} ${s['hair-style']||''} ${s['hair-color']||''}\n`;
  if(s['eye-color']) text += `çœ¼ç›: ${s['eye-shape']||''} ${s['eye-color']}\n`;
  if(s['skin-tone']) text += `è‚¤è‰²: ${s['skin-tone']}\n`;
  if(s['facial-structure']) text += `è„¸å‹: ${s['facial-structure']}\n`;
  if(s['special-marks']) text += `ç‰¹æ®Šæ ‡è®°: ${s['special-marks']}\n`;
  if(s['body-build']) text += `ä½“å‹: ${s['body-build']}\n`;
  if(s['accessories']) text += `é…é¥°: ${s['accessories']}\n`;
  if(s['clothing-style']) text += `æœè£…: ${s['clothing-style']} - ${s['clothing-item']||''}\n`;
  
  text += `\nã€å¿ƒç†ç‰¹å¾ã€‘\n`;
  if(s['phobias']) text += `ææƒ§: ${s['phobias']}\n`;
  if(s['mental_trauma']) text += `åˆ›ä¼¤: ${s['mental_trauma']}\n`;
  if(s['favorite_things']) text += `å–œå¥½: ${s['favorite_things']}\n`;
  if(s['hated_things']) text += `åŒæ¶: ${s['hated_things']}\n`;
  
  return text;
}

function copyPrompt() {
  const text = document.getElementById('prompt-content').textContent;
  navigator.clipboard.writeText(text).then(() => {
    const btn = event.currentTarget;
    const orig = btn.innerHTML;
    btn.innerHTML = '<i class="fa-solid fa-check"></i> å·²å¤åˆ¶';
    setTimeout(() => btn.innerHTML = orig, 2000);
  });
}

// ===== SETTINGS & API =====
function getCleanUrl(raw) {
  let u = raw.trim().replace(/\/$/, "");
  u = u.replace(/\/chat\/completions\/?$/, "");
  return u;
}

function updateUrlPreview() {
  const u = getCleanUrl(document.getElementById('api-url').value);
  document.getElementById('url-preview').textContent = `${u}/chat/completions`;
}

function applyPreset() {
  const v = document.getElementById('api-preset').value;
  const uIn = document.getElementById('api-url');
  const mIn = document.getElementById('api-model');
  
  if(v==='openai') {
    uIn.value="https://api.openai.com/v1";
    mIn.value="gpt-3.5-turbo";
  } else if(v==='gemini') {
    uIn.value="https://generativelanguage.googleapis.com/v1beta/openai";
    mIn.value="gemini-2.0-flash";
  } else if(v==='deepseek') {
    uIn.value="https://api.deepseek.com";
    mIn.value="deepseek-chat";
  }
  updateUrlPreview();
}

async function testConnection() {
  const key = document.getElementById('api-key').value;
  const url = getCleanUrl(document.getElementById('api-url').value);
  const model = document.getElementById('api-model').value;
  const btn = document.getElementById('btn-test-conn');
  const stat = document.getElementById('test-status-text');
  const err = document.getElementById('debug-error-box');
  
  btn.disabled = true;
  btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i>';
  err.classList.add('hidden');
  
  const doReq = async (u) => {
    return await fetch(`${u}/chat/completions`, {
      method: 'POST',
      headers: {
        'Content-Type':'application/json',
        'Authorization':`Bearer ${key}`
      },
      body: JSON.stringify({
        model: model,
        messages: [{role:"user", content:"hi"}]
      })
    });
  };
  
  try {
    let res = await doReq(url);
    
    if(res.status === 404 && url.includes('googleapis') && !url.includes('/openai')) {
      const fix = `${url}/openai`;
      const r2 = await doReq(fix);
      if(r2.ok) {
        res = r2;
        document.getElementById('api-url').value = fix;
        updateUrlPreview();
      }
    }
    
    if(res.ok) {
      stat.innerHTML = '<span class="text-green-600 font-bold">âœ“ è¿æ¥æˆåŠŸ</span>';
      state.api.verified = true;
    } else {
      throw new Error(`HTTP ${res.status}`);
    }
  } catch(e) {
    stat.innerHTML = '<span class="text-red-500">âœ— è¿æ¥å¤±è´¥</span>';
    err.innerHTML = e.message;
    err.classList.remove('hidden');
    state.api.verified = false;
  }
  
  btn.disabled = false;
  btn.innerHTML = "æµ‹è¯•è¿æ¥";
}

function toggleSettings() {
  const m = document.getElementById('settings-modal');
  const c = document.getElementById('modal-content');
  
  if(m.classList.contains('pointer-events-none')) {
    m.classList.remove('opacity-0','pointer-events-none');
    c.classList.add('scale-100');
    document.body.classList.add('modal-active');
  } else {
    m.classList.add('opacity-0','pointer-events-none');
    c.classList.remove('scale-100');
    document.body.classList.remove('modal-active');
  }
}

function saveSettings() {
  state.api.key = document.getElementById('api-key').value;
  state.api.url = getCleanUrl(document.getElementById('api-url').value);
  state.api.model = document.getElementById('api-model').value;
  
  if(state.api.key) state.api.enabled = true;
  
  const dot = document.getElementById('header-status-dot');
  const txt = document.getElementById('header-status-text');
  
  if(state.api.verified) {
    dot.className = "w-2 h-2 rounded-full bg-green-500";
    txt.textContent = "AI åœ¨çº¿";
  } else if (state.api.key) {
    dot.className = "w-2 h-2 rounded-full bg-yellow-500";
    txt.textContent = "æœªéªŒè¯";
  }
  
  toggleSettings();
}

// ===== STEP 5: REPORT GENERATION =====
async function generateReport(format) {
  const btn = event.currentTarget;
  const originalHTML = btn.innerHTML;
  btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> ç”Ÿæˆä¸­...';
  btn.disabled = true;
  
  try {
    const fullProfile = getFullProfile();
    
    // Get deep details from Step 4 questionAnswers
    let deepDetailsText = '';
    if(Object.keys(questionAnswers).length > 0) {
      Object.values(questionAnswers).forEach(qa => {
        deepDetailsText += `ã€${qa.category}ã€‘\né—®é¢˜ï¼š${qa.question}\nå›ç­”ï¼š${qa.answer}\n\n`;
      });
    }
    
    let systemPrompt = '';
    let formatName = '';
    
    switch(format) {
      case 'novel':
        formatName = 'å°è¯´é£æ ¼è§’è‰²æè¿°';
        systemPrompt = `ä½ æ˜¯ä¸“ä¸šçš„å°è¯´ä½œå®¶ã€‚æ ¹æ®è§’è‰²ä¿¡æ¯ï¼Œå†™ä¸€æ®µ800-1000å­—çš„ç¬¬ä¸‰äººç§°è§’è‰²æè¿°ï¼ŒåŒ…å«å¤–è²Œã€æ€§æ ¼ã€èƒŒæ™¯ã€ç‰¹å¾ç­‰ã€‚æ–‡ç¬”ä¼˜ç¾ï¼Œå¯Œæœ‰ç”»é¢æ„Ÿã€‚`;
        break;
      case 'rpg':
        formatName = 'TRPG è§’è‰²å¡ç‰‡';
        systemPrompt = `ä½ æ˜¯TRPGæ¸¸æˆä¸»æŒäººã€‚æ ¹æ®è§’è‰²ä¿¡æ¯ï¼Œç”Ÿæˆä¸€ä»½ç»“æ„åŒ–çš„è§’è‰²å¡ç‰‡ï¼ŒåŒ…å«ï¼šåŸºç¡€ä¿¡æ¯ã€å±æ€§æ•°å€¼ã€æŠ€èƒ½ç‰¹é•¿ã€èƒŒæ™¯æ•…äº‹ã€è£…å¤‡ç‰©å“ã€æ€§æ ¼ç‰¹è´¨ç­‰æ¨¡å—ã€‚æ ¼å¼æ¸…æ™°ï¼Œä¾¿äºè·‘å›¢ä½¿ç”¨ã€‚`;
        break;
      case 'profile':
        formatName = 'å®˜æ–¹æ¡£æ¡ˆæŠ¥å‘Š';
        systemPrompt = `ä½ æ˜¯æ¡£æ¡ˆç®¡ç†å‘˜ã€‚æ ¹æ®è§’è‰²ä¿¡æ¯ï¼Œç”Ÿæˆä¸€ä»½æ­£å¼çš„äººç‰©æ¡£æ¡ˆï¼Œä½¿ç”¨å®˜æ–¹æ–‡æ¡£é£æ ¼ï¼ŒåŒ…å«ï¼šä¸ªäººä¿¡æ¯ã€èº«ä½“ç‰¹å¾ã€å¿ƒç†è¯„ä¼°ã€ç¤¾ä¼šå…³ç³»ã€é‡è¦äº‹ä»¶è®°å½•ç­‰ã€‚è¯­è¨€ä¸¥è°¨ä¸“ä¸šã€‚`;
        break;
      case 'interview':
        formatName = 'äººç‰©è®¿è°ˆè®°å½•';
        systemPrompt = `ä½ æ˜¯è®°è€…ã€‚æ ¹æ®è§’è‰²ä¿¡æ¯ï¼Œç¼–å†™ä¸€ä»½è®¿è°ˆè®°å½•ï¼Œç”¨é—®ç­”å½¢å¼å±•ç°è§’è‰²æ€§æ ¼å’Œç»å†ã€‚åŒ…å«8-10ä¸ªé—®é¢˜ï¼Œè§’è‰²çš„å›ç­”è¦ç¬¦åˆå…¶æ€§æ ¼ç‰¹å¾ã€‚`;
        break;
      case 'diary':
        formatName = 'è§’è‰²æ—¥è®°';
        systemPrompt = `ä½ æ˜¯è§’è‰²æœ¬äººã€‚æ ¹æ®è§’è‰²ä¿¡æ¯ï¼Œä»¥ç¬¬ä¸€äººç§°å†™ä¸€ç¯‡æ—¥è®°ï¼Œè®°å½•æŸä¸ªé‡è¦çš„ä¸€å¤©ï¼Œå±•ç°å†…å¿ƒæƒ³æ³•ã€æƒ…æ„Ÿå˜åŒ–ã€å¯¹è¿‡å»çš„å›å¿†ã€‚800å­—å·¦å³ï¼Œæƒ…æ„ŸçœŸæŒšã€‚`;
        break;
      case 'medical':
        formatName = 'åŒ»ç–—/å¿ƒç†æ¡£æ¡ˆ';
        systemPrompt = `ä½ æ˜¯åŒ»ç”Ÿ/å¿ƒç†åŒ»ç”Ÿã€‚æ ¹æ®è§’è‰²ä¿¡æ¯ï¼Œç”Ÿæˆä¸€ä»½åŒ»ç–—æ¡£æ¡ˆï¼ŒåŒ…å«ï¼šç”Ÿç†æŒ‡æ ‡ã€å¥åº·çŠ¶å†µã€å¿ƒç†è¯„ä¼°ã€åˆ›ä¼¤è®°å½•ã€æ²»ç–—å»ºè®®ç­‰ã€‚ä½¿ç”¨ä¸“ä¸šåŒ»å­¦æœ¯è¯­ã€‚`;
        break;
    }
    
    const prompt = `${systemPrompt}\n\nã€è§’è‰²å®Œæ•´ä¿¡æ¯ã€‘\n${fullProfile}\n\n${deepDetailsText ? 'ã€æ·±åº¦ç»†èŠ‚ã€‘\n' + deepDetailsText : ''}\nè¯·ç”ŸæˆæŠ¥å‘Šï¼š`;
    
    const report = await callAIText(prompt);
    
    // Display report
    document.getElementById('report-title').textContent = formatName;
    document.getElementById('report-time').textContent = new Date().toLocaleString('zh-CN');
    document.getElementById('report-content').textContent = report;
    document.getElementById('report-display').classList.remove('hidden');
    
    // Scroll to report
    document.getElementById('report-display').scrollIntoView({ behavior: 'smooth' });
    
  } catch(e) {
    alert('ç”Ÿæˆå¤±è´¥ï¼š' + e.message);
  }
  
  btn.innerHTML = originalHTML;
  btn.disabled = false;
}

function copyReport() {
  const text = document.getElementById('report-content').textContent;
  navigator.clipboard.writeText(text).then(() => {
    const btn = event.currentTarget;
    const orig = btn.innerHTML;
    btn.innerHTML = '<i class="fa-solid fa-check"></i> å·²å¤åˆ¶';
    setTimeout(() => btn.innerHTML = orig, 2000);
  });
}

function downloadReport() {
  const text = document.getElementById('report-content').textContent;
  const title = document.getElementById('report-title').textContent;
  const nameEl = document.getElementById('input-name');
  const name = nameEl ? nameEl.value : 'æœªå‘½å';
  
  const blob = new Blob([text], { type: 'text/plain;charset=utf-8' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `${name}_${title}_${Date.now()}.txt`;
  a.click();
  URL.revokeObjectURL(url);
}

// ===== INIT =====
window.onload = () => {
  console.log("=== Character Forge V7.0 Initializing ===");
  renderStep1();
  updateUrlPreview();
  
  // Pre-fill API settings
  document.getElementById('api-url').value = state.api.url;
  document.getElementById('api-key').value = state.api.key;
  document.getElementById('api-model').value = state.api.model;
  document.getElementById('api-preset').value = 'deepseek';
  
  // Update status
  const dot = document.getElementById('header-status-dot');
  const txt = document.getElementById('header-status-text');
  dot.className = "w-2 h-2 rounded-full bg-green-500";
  txt.textContent = "DeepSeek å·²é…ç½®";
  
  // Auto-verify connection
  testConnection();
  
  console.log("=== Initialization complete ===");
};
</script>
</body>
</html>

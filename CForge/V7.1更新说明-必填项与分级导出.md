# Character Forge V7.1 更新说明

## 🎉 新功能：必填项验证 & 分级导出

### 更新时间
2024-02-13

---

## 📋 功能 1: 必填项验证

### 概述
为确保角色信息完整性，现在 Step 1 中的关键字段设为必填项。

### 必填字段
- ✅ **姓名**（角色姓名）
- ✅ **核心身份/职业**（角色定位）

### 功能特点

#### 视觉标识
- 必填字段标签后显示红色星号（*）
- 清晰标识哪些字段必须填写

#### 验证逻辑
```javascript
// 点击"确认并生成外貌"时触发验证
1. 检查姓名是否填写
   - 未填写 → 显示错误提示
   - 输入框显示红色边框（2秒）
   - 焦点自动移到该字段

2. 检查职业是否填写
   - 未填写 → 显示错误提示
   - 输入框显示红色边框（2秒）
   - 焦点自动移到该字段

3. 全部填写 → 正常进入 Step 2
```

#### 错误提示
- **姓名未填写**: `❌ 请填写角色姓名`
- **职业未填写**: `❌ 请填写核心身份/职业`

#### 用户体验
- 错误提示使用 alert 弹窗（简单直接）
- 输入框短暂显示红色边框（视觉反馈）
- 自动聚焦到未填写的字段（引导用户）

---

## 💾 功能 2: 分级导出

### 概述
根据创作进度，提供两种导出等级：
- **基础版**（Step 3 后）：仅包含基础信息
- **完整版**（Step 5 后）：包含所有 AI 生成内容

### 导出等级对比

| 特性 | 基础版 | 完整版 |
|------|--------|--------|
| **导出时机** | Step 3 完成后 | Step 5 完成后 |
| **按钮位置** | Step 3 底部（蓝色） | Step 5 底部（绿色） |
| **基础信息** | ✅ | ✅ |
| **属性 & 性格** | ✅ | ✅ |
| **外貌选择** | ✅ | ✅ |
| **心理特征** | ✅ | ✅ |
| **Step 4 问答** | ❌ | ✅ |
| **AI 生成标记** | `false` | `true` |
| **文件大小** | 较小（~5-10 KB） | 较大（~10-50 KB） |
| **适用场景** | 快速备份、分享框架 | 完整存档、深度创作 |

### 基础版导出

#### 触发位置
- **Step 3** 底部
- 按钮：`导出基础版`（蓝色，下载图标）

#### 包含内容
```json
{
  "version": "7.1",
  "exportLevel": "basic",
  "aiGenerated": false,
  "timestamp": "2024-02-13T...",
  "basic": { /* 姓名、性别、年龄等 */ },
  "stats": { /* 6项属性 */ },
  "personality": { /* 8项性格 */ },
  "selections": { /* 外貌、心理选择 */ }
}
```

#### 文件命名
```
character_[姓名]_基础版_[时间戳].json

示例：
character_张三_基础版_1707804600000.json
```

#### 使用场景
- ✅ 快速备份角色框架
- ✅ 分享角色基础设定
- ✅ 在不同设备间传输
- ✅ 作为模板复用

### 完整版导出

#### 触发位置
- **Step 5** 底部
- 按钮：`导出完整版`（绿色，下载图标）

#### 包含内容
```json
{
  "version": "7.1",
  "exportLevel": "full",
  "aiGenerated": true,
  "timestamp": "2024-02-13T...",
  "basic": { /* 姓名、性别、年龄等 */ },
  "stats": { /* 6项属性 */ },
  "personality": { /* 8项性格 */ },
  "selections": { /* 外貌、心理选择 */ },
  "questionAnswers": { /* Step 4 问答内容 */ }
}
```

#### 文件命名
```
character_[姓名]_完整版_[时间戳].json

示例：
character_张三_完整版_1707804600000.json
```

#### 使用场景
- ✅ 完整存档角色
- ✅ 保存创作过程
- ✅ 包含所有 AI 生成内容
- ✅ 用于后续编辑

### 导出提示

#### 成功提示（Toast）
- **基础版**: `✅ 基础版角色已导出（仅包含基础信息）`
- **完整版**: `✅ 完整版角色已导出（包含 AI 生成内容）`
- 显示位置：右上角
- 显示时长：3 秒
- 样式：绿色背景，白色文字，带图标

---

## 📥 功能 3: 智能导入

### 概述
导入功能现在能自动识别导出等级，并显示对应提示。

### 导入流程

#### 1. 选择文件
- 点击右上角"导入角色"按钮
- 选择 JSON 文件

#### 2. 自动识别
```javascript
// 读取 exportLevel 字段
if (exportLevel === 'basic') {
  // 基础版导入
  恢复：基础信息、属性、性格、选择
  不恢复：Step 4 问答
} else if (exportLevel === 'full') {
  // 完整版导入
  恢复：所有内容（包括 Step 4 问答）
}
```

#### 3. 显示提示
- **基础版**: `✅ 基础版角色导入成功（仅基础信息）`
- **完整版**: `✅ 完整版角色导入成功（包含 AI 生成内容）`
- 显示位置：右上角
- 显示时长：3 秒
- 样式：蓝色背景，白色文字，带图标

#### 4. 数据恢复
- 基础信息自动填充
- 属性点自动更新
- 性格滑块自动调整
- 选择项自动恢复
- 预览面板实时更新

---

## 🎨 界面变化

### Step 1 - 基础档案
```
姓名 *              [输入框] [生成]
核心身份/职业 *      [输入框] [生成]

* = 必填项（红色星号）
```

### Step 3 - 精神特质
```
提示框：
💾 完成此步骤后可导出基础版（不含 AI 深度细化内容）

底部按钮：
[返回修改外貌]  [导出基础版] [下一步：深度细化]
                  ↑ 蓝色按钮
```

### Step 5 - 最终报告
```
提示框：
💾 完成报告后可导出完整版（包含所有 AI 生成内容）

底部按钮：
[返回细化]  [导出完整版] [重新开始]
              ↑ 绿色按钮
```

---

## 🔧 技术实现

### 必填项验证
```javascript
async function finishStep1() {
  // 验证姓名
  const name = document.getElementById('input-name').value.trim();
  if (!name) {
    alert('❌ 请填写角色姓名');
    document.getElementById('input-name').focus();
    document.getElementById('input-name').classList.add('border-red-500');
    setTimeout(() => document.getElementById('input-name').classList.remove('border-red-500'), 2000);
    return;
  }
  
  // 验证职业
  const archetype = document.getElementById('input-archetype').value.trim();
  if (!archetype) {
    alert('❌ 请填写核心身份/职业');
    document.getElementById('input-archetype').focus();
    document.getElementById('input-archetype').classList.add('border-red-500');
    setTimeout(() => document.getElementById('input-archetype').classList.remove('border-red-500'), 2000);
    return;
  }
  
  // 验证通过，进入 Step 2
  goToStep(2);
  // ...
}
```

### 分级导出
```javascript
function exportCharacter(level = 'full') {
  const data = {
    version: "7.1",
    exportLevel: level, // 'basic' or 'full'
    aiGenerated: level === 'full',
    // ... 基础数据
  };
  
  // 只有完整版才包含 AI 内容
  if (level === 'full') {
    data.questionAnswers = questionAnswers;
  }
  
  // 生成文件
  const levelLabel = level === 'full' ? '完整版' : '基础版';
  const filename = `character_${name}_${levelLabel}_${Date.now()}.json`;
  
  // 显示提示
  showToast(level === 'full' 
    ? '✅ 完整版角色已导出（包含 AI 生成内容）'
    : '✅ 基础版角色已导出（仅包含基础信息）'
  );
}
```

### Toast 提示
```javascript
function showToast(message, color = 'green') {
  const toast = document.createElement('div');
  toast.className = `fixed top-20 right-4 bg-${color}-600 text-white px-6 py-3 rounded-lg shadow-lg z-50`;
  toast.innerHTML = `<i class="fa-solid fa-check-circle mr-2"></i>${message}`;
  document.body.appendChild(toast);
  
  setTimeout(() => {
    toast.style.opacity = '0';
    toast.style.transition = 'opacity 0.3s';
    setTimeout(() => toast.remove(), 300);
  }, 3000);
}
```

---

## 📊 数据格式变化

### V7.0 → V7.1

#### 新增字段
```json
{
  "version": "7.1",           // 版本号更新
  "exportLevel": "basic",     // 新增：导出等级
  "aiGenerated": false,       // 新增：AI 生成标记
  // ...
}
```

#### 向后兼容
- V7.0 文件可以正常导入
- 自动识别为完整版（包含 questionAnswers）
- 不影响现有功能

---

## 🧪 测试

### 测试文件
`tests/test-validation-export.html`

### 测试项目
1. ✅ 必填项验证（姓名、职业）
2. ✅ 基础版导出（Step 3）
3. ✅ 完整版导出（Step 5）
4. ✅ 基础版导入
5. ✅ 完整版导入
6. ✅ Toast 提示显示
7. ✅ 文件命名正确
8. ✅ 数据完整性

---

## 💡 使用建议

### 何时使用基础版？
- ✅ 刚完成角色框架，想快速备份
- ✅ 需要分享角色设定给他人参考
- ✅ 在多个设备间同步基础信息
- ✅ 作为角色模板复用

### 何时使用完整版？
- ✅ 完成所有创作步骤
- ✅ 需要保存完整创作过程
- ✅ 包含 AI 生成的深度内容
- ✅ 用于后续编辑和完善

### 最佳实践
1. **Step 3 后**：导出基础版作为快照
2. **Step 5 后**：导出完整版作为最终存档
3. **定期备份**：重要角色建议导出多个版本
4. **命名规范**：文件名自动包含版本标签，便于区分

---

## 🔄 版本兼容性

### 导入兼容性
| 导出版本 | V7.1 导入 | 说明 |
|----------|-----------|------|
| V7.0 | ✅ | 自动识别为完整版 |
| V7.1 基础版 | ✅ | 恢复基础信息 |
| V7.1 完整版 | ✅ | 恢复所有内容 |

### 导出兼容性
| 导出等级 | V7.0 导入 | V7.1 导入 |
|----------|-----------|-----------|
| 基础版 | ⚠️ 可能缺少字段 | ✅ |
| 完整版 | ✅ | ✅ |

---

## 📝 更新日志

### V7.1 (2024-02-13)
- ✅ 新增必填项验证（姓名、职业）
- ✅ 新增分级导出（基础版、完整版）
- ✅ 优化导入功能（自动识别版本）
- ✅ 新增 Toast 提示（导出/导入成功）
- ✅ 更新数据格式（exportLevel, aiGenerated）
- ✅ 新增测试文件（test-validation-export.html）

---

## 🎯 未来计划

### 短期
- [ ] 添加"另存为"功能
- [ ] 支持批量导出
- [ ] 导出历史记录

### 长期
- [ ] 云端同步
- [ ] 版本对比
- [ ] 协作编辑

---

**Character Forge V7.1** - 让角色创作更完整、更灵活 ✨

更新时间：2024-02-13
